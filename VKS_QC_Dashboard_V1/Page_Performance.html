<!-- Page_Performance.html - Comprehensive Performance Analytics -->
<div id="page-performance" class="page-content">
    <style>
        /* === V2 SCATTER PLOT STYLES === */
        .shift-graph-container {
            position: relative;
        }

        .shift-graph-wrapper {
            position: relative;
            height: 400px;
            width: calc(100% - 55px);
            margin-left: 55px;
            border-left: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
        }

        .shift-y-axis {
            position: absolute;
            left: -55px;
            height: 100%;
            width: 50px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            font-size: 10px;
            color: var(--text-muted);
            text-align: right;
            padding-right: 8px;
        }

        .shift-x-axis {
            display: flex;
            justify-content: space-between;
            margin-left: 55px;
            margin-top: 12px;
            font-size: 10px;
            color: var(--text-muted);
        }

        .shift-v-grid {
            position: absolute;
            inset: 0;
            display: flex;
            justify-content: space-between;
            pointer-events: none;
        }

        .shift-v-grid-line {
            width: 1px;
            height: 100%;
            background: var(--border);
            opacity: 0.3;
        }

        .shift-region {
            position: absolute;
            left: 0;
            right: 0;
            width: 100%;
        }

        .shift-1-region {
            top: 0;
            height: 33.33%;
            background: rgba(59, 130, 246, 0.08);
            border-bottom: 1px dashed var(--border);
        }

        .shift-2-region {
            top: 33.33%;
            height: 33.33%;
            background: rgba(245, 158, 11, 0.08);
            border-bottom: 1px dashed var(--border);
        }

        .shift-3-region {
            top: 66.66%;
            height: 33.34%;
            background: rgba(168, 85, 247, 0.08);
        }

        .shift-scatter-svg {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            overflow: visible;
            z-index: 10;
        }

        .shift-dot {
            pointer-events: none;
            stroke: var(--surface);
            stroke-width: 2;
        }

        /* Tooltip */
        #scatter-tooltip {
            position: fixed;
            z-index: 9999;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 12px;
            box-shadow: var(--shadow-lg);
            pointer-events: none;
            min-width: 140px;
            font-size: 12px;
        }

        /* === BULK EXPORT MODAL STYLES (V2.1 Port) === */
        .dialog-overlay {
            position: fixed;
            inset: 0;
            z-index: 9999;
            background-color: rgba(15, 23, 42, 0.65);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
        }

        .dialog-overlay.active {
            display: flex;
            animation: fadeIn 0.2s ease-out;
        }

        .export-dialog {
            width: 95vw;
            max-width: 1600px;
            height: 90vh;
            max-height: 900px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--surface);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--border);
        }

        .dialog-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            background: var(--surface);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        /* Two-Pane Layout */
        .export-layout {
            display: grid;
            grid-template-columns: 1fr 380px;
            flex: 1;
            overflow: hidden;
        }

        /* Preview Pane */
        .export-preview-pane {
            background: #f1f5f9;
            /* hsl(var(--muted)) approximation */
            overflow: auto;
            padding: 32px;
            display: flex;
            flex-direction: column;
            align-items: center;
            border-right: 1px solid var(--border);
        }

        /* PDF Page Simulation ‚Äî V2.1 Exact */
        .export-pdf-page {
            background: white;
            width: 1000px;
            min-height: 700px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            padding: 40px;
            display: flex;
            flex-direction: column;
            color: #1e293b;
            transform: scale(0.7);
            transform-origin: top center;
            margin-bottom: -210px;
            flex-shrink: 0;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
        }

        .export-pdf-header {
            margin-bottom: 16px;
        }

        .export-pdf-title {
            font-size: 28px;
            font-weight: 800;
            color: #0f172a;
            letter-spacing: -0.025em;
            margin: 0;
        }

        .export-pdf-subtitle {
            font-size: 16px;
            font-weight: 600;
            text-transform: uppercase;
            border-bottom: 2px solid #0f172a;
            padding-bottom: 8px;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }

        .export-pdf-subtitle h2 {
            font-size: 16px;
            font-weight: 700;
            margin: 0;
            color: #0f172a;
        }

        /* Chart Container */
        .export-pdf-chart-container {
            flex: 1;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            min-height: 350px;
            overflow: hidden;
        }

        .export-y-axis {
            width: 45px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            font-size: 9px;
            color: #94a3b8;
            font-weight: 500;
            text-align: right;
            padding-right: 8px;
            padding-top: 8px;
            padding-bottom: 8px;
        }

        .export-chart-area {
            flex: 1;
            position: relative;
            border-left: 1px solid #e2e8f0;
            border-bottom: 1px solid #e2e8f0;
            background: #fafafa;
            /* min-height removed ‚Äî let chart fill available space within fixed 595px page */
        }

        .export-shift-regions {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            /* Vertical layout for horizontal bands (time on Y-axis) */
            opacity: 0.4;
            pointer-events: none;
        }

        .export-shift-regions .shift-1-region {
            flex: 1;
            /* 8 hours */
            background: rgba(59, 130, 246, 0.15);
            border-bottom: 1px dashed rgba(59, 130, 246, 0.3);
        }

        .export-shift-regions .shift-2-region {
            flex: 1;
            /* 8 hours */
            background: rgba(245, 158, 11, 0.15);
            border-bottom: 1px dashed rgba(245, 158, 11, 0.3);
        }

        .export-shift-regions .shift-3-region {
            flex: 1;
            background: rgba(168, 85, 247, 0.15);
        }

        .export-scatter-grid {
            position: absolute;
            inset: 0;
            background-image: linear-gradient(to right, #e2e8f0 1px, transparent 1px), linear-gradient(to bottom, #e2e8f0 1px, transparent 1px);
            background-size: calc(100% / 31) calc(100% / 24);
            /* 31 days X, 24 hours Y */
            opacity: 0.5;
            pointer-events: none;
        }

        .export-scatter-dots {
            position: absolute;
            inset: 0;
            z-index: 10;
        }

        /* V2.1 Premium Dot Style for Export */
        .export-scatter-dots .scatter-dot {
            position: absolute;
            /* Ensure absolute positioning applies */
            width: 8px;
            height: 8px;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            border: 1.5px solid white;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        /* Shift Legend (V2.1 Port) */
        .shift-legend {
            display: flex;
            gap: 24px;
            margin-bottom: 8px;
            /* Adjusted for tight layout */
        }

        .shift-legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #475569;
        }

        .shift-legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .shift-1-dot {
            background-color: #3b82f6;
        }

        .shift-2-dot {
            background-color: #f59e0b;
        }

        .shift-3-dot {
            background-color: #a855f7;
        }


        .export-x-axis {
            display: flex;
            margin-left: 45px;
            margin-top: 8px;
            font-size: 9px;
            color: #94a3b8;
            font-weight: 500;
            justify-content: space-between;
        }

        /* Sidebar */
        .export-sidebar {
            width: 380px;
            background: var(--surface);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .export-sidebar-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .export-sidebar-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--border);
            background: #f8fafc;
        }

        /* Bundle List */
        .export-bundle-list {
            max-height: 250px;
            overflow-y: auto;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
        }

        .export-bundle-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.15s;
        }

        .export-bundle-item:hover {
            background: var(--hover-bg);
        }

        .export-bundle-item.active {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
        }

        /* Pagination */
        .export-pagination {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
            background: var(--surface);
            padding: 0.5rem 1rem;
            border-radius: var(--radius-full);
            box-shadow: var(--shadow-sm);
        }

        /* Utilities */
        .stat-icon-destructive {
            width: 3rem;
            height: 3rem;
            background: #fee2e2;
            color: #ef4444;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-lg);
            font-size: 1.5rem;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        .hidden {
            display: none !important;
        }

        /* === POLAR AREA CHART STYLES (Premium Stitch Design) === */
        .polar-chart-widget {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4),
                inset 0 0 0 1px rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-xl);
            position: relative;
            overflow: hidden;
        }

        .polar-chart-widget::before {
            content: '';
            position: absolute;
            top: -150px;
            right: -100px;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(99, 102, 241, 0.15) 0%, transparent 70%);
            pointer-events: none;
        }

        .polar-chart-widget .card-header {
            background: transparent;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .polar-chart-widget .card-header h3 {
            color: #f8fafc;
        }

        .polar-chart-widget .card-header p {
            color: #94a3b8;
        }

        .polar-chart-container {
            background: rgba(15, 23, 42, 0.6);
            border-radius: var(--radius-lg);
            padding: 2rem;
            text-align: center;
            position: relative;
            min-height: 420px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }

        .polar-chart-container:hover {
            border-color: rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 30px rgba(99, 102, 241, 0.1);
        }

        .polar-chart-container.route-a {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(15, 23, 42, 0.8) 100%);
        }

        .polar-chart-container.route-b {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(15, 23, 42, 0.8) 100%);
        }

        .polar-route-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .polar-route-badge .indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .polar-route-badge.route-a .indicator {
            background: #3b82f6;
            box-shadow: 0 0 8px rgba(59, 130, 246, 0.8);
        }

        .polar-route-badge.route-b .indicator {
            background: #f59e0b;
            box-shadow: 0 0 8px rgba(245, 158, 11, 0.8);
        }

        .polar-chart-title {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin: 0;
        }

        .polar-route-badge.route-a .polar-chart-title {
            color: rgba(147, 197, 253, 0.8);
        }

        .polar-route-badge.route-b .polar-chart-title {
            color: rgba(252, 211, 77, 0.8);
        }

        .polar-chart-stats {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 20;
            pointer-events: none;
        }

        .polar-stat-total {
            font-size: 2.5rem;
            font-weight: 700;
            color: #ffffff;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            line-height: 1;
        }

        .polar-stat-label {
            font-size: 0.625rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            margin-top: 0.25rem;
        }

        .polar-chart-container.route-a .polar-stat-label {
            color: rgba(147, 197, 253, 0.6);
        }

        .polar-chart-container.route-b .polar-stat-label {
            color: rgba(252, 211, 77, 0.6);
        }

        .polar-chart-wrapper {
            position: relative;
            width: 100%;
            max-width: 340px;
            margin: 0 auto;
            padding: 1rem 0;
        }

        .chart-glow-blue {
            filter: drop-shadow(0 0 12px rgba(59, 130, 246, 0.4));
        }

        .chart-glow-amber {
            filter: drop-shadow(0 0 12px rgba(245, 158, 11, 0.4));
        }

        .polar-chart-loading,
        .polar-chart-error {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            padding: 4rem;
            color: #94a3b8;
            font-size: 0.875rem;
            min-height: 340px;
        }

        .polar-chart-error {
            color: #ef4444;
        }

        .polar-chart-error .material-symbols-outlined {
            font-size: 2.5rem;
            opacity: 0.6;
        }

        .polar-widget-footer {
            background: rgba(15, 23, 42, 0.95);
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .polar-footer-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #94a3b8;
            font-size: 0.75rem;
        }

        .polar-footer-status .material-symbols-outlined {
            font-size: 1rem;
            color: #10b981;
        }


        /* Toggle Switch for Legend */
        .toggle-switch {
            width: 40px;
            height: 22px;
            background: var(--border);
            border-radius: var(--radius-full);
            position: relative;
            cursor: pointer;
            transition: background 0.2s;
            border: none;
            padding: 0;
        }

        .toggle-switch.active {
            background: var(--primary);
        }

        .toggle-knob {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            transition: transform 0.2s;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .toggle-switch.active .toggle-knob {
            transform: translateX(18px);
        }

        .toggle-label {
            user-select: none;
        }

        /* Indigo color for icon */
        .bg-indigo-100 {
            background: rgba(99, 102, 241, 0.1);
        }

        .text-indigo-600 {
            color: #4f46e5;
        }
    </style>


    <!-- Global Header -->
    <div class="filter-bar">
        <div>
            <h2 class="text-lg font-semibold" data-i18n="perf.title">Performance Analytics</h2>
            <p class="text-sm text-muted" data-i18n="perf.subtitle">Comprehensive QC operations overview</p>
        </div>
        <div class="flex items-center gap-3 ml-auto">
            <!-- Date Range with Calendar Icon -->
            <div class="flex items-center gap-2" style="position: relative;">
                <button type="button" class="btn btn-outline btn-sm" id="perf-date-btn"
                    onclick="document.getElementById('perf-date-range').click(); document.getElementById('perf-date-range').focus();"
                    style="display: flex; align-items: center; gap: 6px;">
                    <span class="material-symbols-outlined">calendar_month</span>
                    <span id="perf-date-label" data-i18n="perf.this_month">This Month</span>
                </button>
                <input type="text" id="perf-date-range" class="input" placeholder="Select date range"
                    style="position: absolute; opacity: 0; pointer-events: none; width: 0; height: 0;">
            </div>
            <button class="btn btn-primary btn-sm" onclick="exportPerformanceReport()">
                <span class="material-symbols-outlined">download</span>
                <span data-i18n="common.export">Export</span>
            </button>
        </div>
    </div>

    <!-- Loading State -->
    <div id="perf-loading" class="card p-8 text-center mb-4">
        <div class="loading-spinner mx-auto mb-4"></div>
        <p class="text-muted" data-i18n="perf.loading">Loading performance data...</p>
    </div>

    <!-- Content Container (hidden while loading) -->
    <div id="perf-content" style="display: none;">

        <!-- Tab Bar -->
        <div class="perf-tab-bar mb-4">
            <div class="perf-tabs">
                <button class="perf-tab active" data-tab="inspections" onclick="switchPerfTab('inspections')">
                    <span class="material-symbols-outlined">fact_check</span>
                    <span data-i18n="perf.tab_inspections">Inspections</span>
                </button>
                <button class="perf-tab" data-tab="guards" onclick="switchPerfTab('guards')">
                    <span class="material-symbols-outlined">shield_person</span>
                    <span data-i18n="perf.tab_guards">Guards</span>
                </button>
                <button class="perf-tab" data-tab="sites" onclick="switchPerfTab('sites')">
                    <span class="material-symbols-outlined">location_on</span>
                    <span data-i18n="perf.tab_sites">Sites</span>
                </button>
                <button class="perf-tab" data-tab="issues" onclick="switchPerfTab('issues')">
                    <span class="material-symbols-outlined">report_problem</span>
                    <span data-i18n="perf.tab_issues">Issues</span>
                </button>
                <button class="perf-tab" data-tab="handovers" onclick="switchPerfTab('handovers')">
                    <span class="material-symbols-outlined">swap_horiz</span>
                    <span data-i18n="perf.tab_handovers">Handovers</span>
                </button>
                <button class="perf-tab" data-tab="special" onclick="switchPerfTab('special')">
                    <span class="material-symbols-outlined">star</span>
                    <span data-i18n="perf.tab_special_duty">Special Duty</span>
                </button>
                <button class="perf-tab" data-tab="ai" onclick="switchPerfTab('ai')">
                    <span class="material-symbols-outlined">neurology</span>
                    <span data-i18n="perf.tab_ai">AI Analysis</span>
                </button>
            </div>
        </div>

        <!-- TAB: AI Analysis -->
        <div id="perf-tab-ai" class="perf-tab-content" style="display:none;">

            <!-- Section 1: Operational Briefing -->
            <div class="card mb-4 ai-section">
                <div class="card-header ai-section-header">
                    <div class="flex items-center gap-3">
                        <span class="ai-section-icon">üìã</span>
                        <div>
                            <h3 class="font-semibold" data-i18n="ai.briefing_title">Operational Briefing</h3>
                            <p class="text-xs text-muted" id="ai-briefing-meta"></p>
                        </div>
                    </div>
                    <button class="btn btn-ghost btn-sm" onclick="regenerateBriefing()" id="ai-briefing-regen-btn">
                        <span class="material-symbols-outlined text-sm">refresh</span>
                        <span data-i18n="ai.regenerate">Regenerate</span>
                    </button>
                </div>
                <div class="ai-cards-container" id="ai-briefing-cards">
                    <div class="ai-loading-state">
                        <span class="material-symbols-outlined spin">progress_activity</span>
                        <span data-i18n="ai.loading">Loading insights...</span>
                    </div>
                </div>
            </div>

            <!-- Section 2: Deep Analysis (On-Demand) -->
            <div class="card mb-4 ai-section">
                <div class="card-header ai-section-header">
                    <div class="flex items-center gap-3">
                        <span class="ai-section-icon">üìä</span>
                        <div>
                            <h3 class="font-semibold" data-i18n="ai.deep_analysis_title">Deep Analysis</h3>
                            <p class="text-xs text-muted" data-i18n="ai.deep_analysis_sub">Select a topic and analyze
                                with AI</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <select id="ai-topic-select" class="input input-sm" style="width: auto; min-width: 140px;">
                            <option value="patrols" data-i18n="ai.topic_patrols">Patrols</option>
                            <option value="inspections" data-i18n="ai.topic_inspections">Inspections</option>
                            <option value="incidents" data-i18n="ai.topic_incidents">Incidents</option>
                            <option value="sites" data-i18n="ai.topic_sites">Sites</option>
                        </select>
                        <button class="btn btn-primary btn-sm" onclick="runDeepAnalysis()" id="ai-analyze-btn">
                            <span class="material-symbols-outlined text-sm">neurology</span>
                            <span data-i18n="ai.analyze_btn">Analyze</span>
                        </button>
                    </div>
                </div>
                <div class="ai-cards-container" id="ai-deep-cards">
                    <div class="ai-empty-state">
                        <span class="material-symbols-outlined"
                            style="font-size: 48px; color: var(--text-muted);">neurology</span>
                        <p class="text-muted" data-i18n="ai.select_topic">Select a topic and click Analyze to get
                            AI-powered insights</p>
                    </div>
                </div>
            </div>

            <!-- Section 3: Risk Patterns -->
            <div class="card mb-4 ai-section">
                <div class="card-header ai-section-header">
                    <div class="flex items-center gap-3">
                        <span class="ai-section-icon">üîç</span>
                        <div>
                            <h3 class="font-semibold" data-i18n="ai.risk_title">Risk Patterns</h3>
                            <p class="text-xs text-muted" id="ai-patterns-meta"></p>
                        </div>
                    </div>
                    <button class="btn btn-ghost btn-sm" onclick="regeneratePatterns()" id="ai-patterns-regen-btn">
                        <span class="material-symbols-outlined text-sm">refresh</span>
                        <span data-i18n="ai.regenerate">Regenerate</span>
                    </button>
                </div>
                <div class="ai-cards-container" id="ai-patterns-cards">
                    <div class="ai-loading-state">
                        <span class="material-symbols-outlined spin">progress_activity</span>
                        <span data-i18n="ai.loading">Loading insights...</span>
                    </div>
                </div>
            </div>

            <!-- Powered by footer -->
            <div class="ai-powered-footer">
                <span class="ai-badge">Powered by Gemini 2.0 Flash</span>
            </div>
        </div>

        <!-- TAB: Inspections -->
        <div id="perf-tab-inspections" class="perf-tab-content">
            <!-- ===========================================
             SECTION 1: INSPECTION PERFORMANCE
             =========================================== -->
            <div class="card mb-4">
                <div class="card-header perf-section-header">
                    <div class="flex items-center gap-3">
                        <span class="perf-section-icon bg-blue-100 text-blue-600">
                            <span class="material-symbols-outlined">fact_check</span>
                        </span>
                        <div>
                            <h3 class="font-semibold" data-i18n="perf.inspection_title">Inspection Performance</h3>
                            <p class="text-xs text-muted" data-i18n="perf.inspection_sub">QC inspection metrics and
                                activity
                            </p>
                        </div>
                    </div>
                    <!-- Filter Row: Route Pills + Site Multi-select + Inspector Filter -->
                    <div class="perf-filter-row"
                        style="display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; margin-bottom: 1rem;">
                        <!-- Route Filter (Dropdown) -->
                        <div class="perf-filter-dropdown">
                            <label class="text-xs text-muted" style="display: block; margin-bottom: 4px;"
                                data-i18n="perf.filter_route">Route</label>
                            <div class="custom-select w-40" data-select-id="perfRouteSelect"
                                id="perfRouteSelect-select">
                                <button class="custom-select-trigger" onclick="togglePerfRouteSelect()">
                                    <span class="custom-select-value" id="perfRouteSelectLabel"
                                        data-i18n="perf.all_routes">All Routes</span>
                                    <span class="material-symbols-outlined">expand_more</span>
                                </button>
                                <div class="custom-select-menu" id="perfRouteSelect-options">
                                    <!-- Populated by JS like Inspector dropdown -->
                                </div>
                                <input type="hidden" name="perfRouteSelect" id="perfRouteSelect" value="">
                            </div>
                        </div>

                        <!-- Site Filter (Multi-select) -->
                        <div class="perf-filter-dropdown">
                            <label class="text-xs text-muted" style="display: block; margin-bottom: 4px;"
                                data-i18n="perf.filter_sites">Sites</label>
                            <div class="custom-select w-44" data-select-id="perfSiteSelect" id="perfSiteSelect-select">
                                <button class="custom-select-trigger" onclick="togglePerfSiteSelect()">
                                    <span class="custom-select-value" id="perfSiteSelectLabel"
                                        data-i18n="perf.all_sites">All Sites</span>
                                    <span class="multi-select-badge hidden" id="perfSiteCount">0</span>
                                    <span class="material-symbols-outlined">expand_more</span>
                                </button>
                                <div class="custom-select-menu" id="perfSiteSelect-options"
                                    style="right: 0; left: auto; min-width: 280px;">
                                    <!-- Populated by JS -->
                                </div>
                                <input type="hidden" name="perfSiteSelect" id="perfSiteSelect" value="">
                            </div>
                        </div>

                        <!-- Inspector Filter -->
                        <div class="perf-filter-dropdown">
                            <label class="text-xs text-muted" style="display: block; margin-bottom: 4px;"
                                data-i18n="perf.filter_inspector">Inspector</label>
                            <div class="custom-select w-40" data-select-id="perfInspectorSelect"
                                id="perfInspectorSelect-select">
                                <button class="custom-select-trigger" onclick="togglePerfInspectorSelect()">
                                    <span class="custom-select-value" id="perfInspectorSelectLabel"
                                        data-i18n="perf.all_inspectors">All Inspectors</span>
                                    <span class="material-symbols-outlined">expand_more</span>
                                </button>
                                <div class="custom-select-menu" id="perfInspectorSelect-options">
                                    <!-- Populated by JS -->
                                </div>
                                <input type="hidden" name="perfInspectorSelect" id="perfInspectorSelect" value="">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-content">
                    <!-- Stats Row -->
                    <div class="perf-stats-row">
                        <!-- Existing KPI 1: Total Inspections -->
                        <div class="perf-stat-card">
                            <div class="perf-stat-value" id="insp-total">--</div>
                            <div class="perf-stat-label" data-i18n="perf.total_inspections">Total Inspections</div>
                            <div class="perf-stat-trend" id="insp-trend">
                                <span class="material-symbols-outlined">trending_up</span>
                                <span id="insp-trend-val">+0%</span>
                            </div>
                        </div>

                        <!-- NEW KPI 4: Avg Inspections/Day -->
                        <div class="perf-stat-card">
                            <div class="perf-stat-value" id="insp-avg-day">--</div>
                            <div class="perf-stat-label" data-i18n="perf.avg_per_day">Avg / Day</div>
                            <div class="perf-stat-target text-muted" id="insp-target-day">
                                <span class="material-symbols-outlined text-xs">flag</span>
                                <span data-i18n="perf.target">Target</span>: <span id="insp-target-val">24</span>
                            </div>
                        </div>
                        <!-- NEW KPI 5: Compliance Rate -->
                        <div class="perf-stat-card">
                            <div class="perf-stat-value" id="insp-compliance">--%</div>
                            <div class="perf-stat-label" data-i18n="perf.compliance_rate">Compliance Rate</div>
                            <div class="perf-stat-badge" id="insp-compliance-badge">
                                <span class="badge badge-success" id="insp-compliance-status">
                                    <span class="material-symbols-outlined text-xs">check_circle</span>
                                    <span data-i18n="perf.consistent">Consistent</span>
                                </span>
                            </div>
                        </div>
                        <!-- NEW KPI 6: Most Active Shift -->
                        <div class="perf-stat-card">
                            <div class="perf-stat-value perf-shift-highlight" id="insp-active-shift">--</div>
                            <div class="perf-stat-label" data-i18n="perf.most_active_shift">Most Active Shift</div>
                            <div class="perf-stat-sublabel text-muted" id="insp-shift-time">--:-- - --:--</div>
                        </div>
                    </div>

                    <!-- Scatter Chart -->
                    <div class="perf-chart-container" id="scatter-chart-container">
                        <div class="perf-chart-header">
                            <h4 id="scatter-header-title" class="text-sm font-medium"
                                data-i18n="perf.inspection_activity">Inspection Activity
                            </h4>
                            <div class="perf-chart-controls" style="display: flex; gap: 1rem; align-items: center;">
                                <!-- Type Filter Pills -->
                                <div class="perf-filter-pills" id="scatter-type-pills">
                                    <button class="perf-pill active" data-value="all"
                                        onclick="filterScatterType('all')">All</button>
                                    <button class="perf-pill" data-value="inspection"
                                        onclick="filterScatterType('inspection')">
                                        <span class="legend-dot shift-1" style="margin-right:4px;"></span>Inspection
                                    </button>
                                    <button class="perf-pill" data-value="stationary"
                                        onclick="filterScatterType('stationary')">
                                        <span class="legend-dot special-stationary"
                                            style="margin-right:4px;"></span>Stationary
                                    </button>
                                    <button class="perf-pill" data-value="onboarding"
                                        onclick="filterScatterType('onboarding')">
                                        <span class="legend-dot special-onboarding"
                                            style="margin-right:4px;"></span>Onboarding
                                    </button>
                                </div>
                                <!-- Day/Week Toggle -->
                                <div style="display: flex; gap: 0.25rem;">
                                    <button class="perf-toggle active" id="scatter-day-btn"
                                        onclick="toggleScatterInterval('day')">Day</button>
                                    <button class="perf-toggle" id="scatter-week-btn"
                                        onclick="toggleScatterInterval('week')">Week</button>
                                </div>
                                <button class="btn-icon ml-2" onclick="toggleScatterFullscreen()">
                                    <span class="material-symbols-outlined">fullscreen</span>
                                </button>
                            </div>
                        </div>
                        <!-- V2-Style Shift Graph Container -->
                        <div class="shift-graph-container">
                            <div class="shift-graph-wrapper" id="shiftGraphWrapper">
                                <!-- Y-Axis Labels (25 hourly labels from 06:00‚Üí06:00, populated by JS) -->
                                <div class="shift-y-axis" id="shiftYAxis"></div>
                                <!-- Shift Background Regions (3 equal sections) -->
                                <div class="shift-region shift-1-region"></div>
                                <div class="shift-region shift-2-region"></div>
                                <div class="shift-region shift-3-region"></div>
                                <!-- Vertical Grid Lines -->
                                <div class="shift-v-grid" id="shiftVGrid"></div>
                                <!-- SVG for scatter plot points -->
                                <svg class="shift-scatter-svg" id="shiftScatterSvg"></svg>
                            </div>
                            <!-- X-Axis Labels -->
                            <div class="shift-x-axis" id="shiftXAxis"></div>
                        </div>
                        <div class="scatter-legend">
                            <span class="legend-item"><span class="legend-dot shift-1"></span> Shift 1 (06-14)</span>
                            <span class="legend-item"><span class="legend-dot shift-2"></span> Shift 2 (14-22)</span>
                            <span class="legend-item"><span class="legend-dot shift-3"></span> Shift 3 (22-06)</span>
                            <span class="legend-item"><span class="legend-dot special-stationary"></span>
                                Stationary</span>
                            <span class="legend-item"><span class="legend-dot special-onboarding"></span>
                                Onboarding</span>
                        </div>
                    </div>
                </div>
            </div>
        </div><!-- /perf-tab-inspections -->

        <!-- TAB: Guards -->
        <div id="perf-tab-guards" class="perf-tab-content" style="display:none;">
            <!-- ===========================================
             SECTION 2: GUARD PERFORMANCE
             =========================================== -->
            <div class="card mb-4">
                <div class="card-header perf-section-header">
                    <div class="flex items-center gap-3">
                        <span class="perf-section-icon bg-orange-100 text-orange-600">
                            <span class="material-symbols-outlined">shield_person</span>
                        </span>
                        <div>
                            <h3 class="font-semibold" data-i18n="perf.guard_title">Guard Performance</h3>
                            <p class="text-xs text-muted" data-i18n="perf.guard_sub">Active guards and scan metrics
                            </p>
                        </div>
                    </div>
                    <div class="perf-filter-pills" id="guard-shift-pills">
                        <button class="perf-pill active" data-value="" onclick="filterPerfGuards('')"
                            data-i18n="perf.all_shifts">All Shifts</button>
                        <button class="perf-pill" data-value="morning" onclick="filterPerfGuards('morning')">
                            <span class="material-symbols-outlined text-xs">sunny</span> AM
                        </button>
                        <button class="perf-pill" data-value="evening" onclick="filterPerfGuards('evening')">
                            <span class="material-symbols-outlined text-xs">wb_twilight</span> PM
                        </button>
                        <button class="perf-pill" data-value="night" onclick="filterPerfGuards('night')">
                            <span class="material-symbols-outlined text-xs">bedtime</span> Night
                        </button>
                    </div>
                </div>
                <div class="card-content">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                        <!-- Stats Row -->
                        <div class="perf-stats-row">
                            <div class="perf-stat-card">
                                <div class="perf-stat-value" id="guard-active">--</div>
                                <div class="perf-stat-label" data-i18n="perf.active_guards">Active Guards</div>
                            </div>
                            <div class="perf-stat-card">
                                <div class="perf-stat-value" id="guard-ontime">--<small>%</small></div>
                                <div class="perf-stat-label" data-i18n="perf.on_time_rate">On-Time Rate</div>
                                <div class="perf-stat-progress">
                                    <div class="progress-bar">
                                        <div class="progress-fill bg-orange-500" id="guard-ontime-bar"
                                            style="width: 0%">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="perf-stat-card">
                                <div class="perf-stat-value" id="guard-scans">--</div>
                                <div class="perf-stat-label" data-i18n="perf.avg_scans">Avg Scans/Day</div>
                            </div>
                        </div>

                        <!-- Top Performers -->
                        <div class="perf-leaderboard">
                            <h4 class="text-sm font-medium mb-3" data-i18n="perf.top_performers">Top Performers</h4>
                            <div class="leaderboard-list" id="guard-leaderboard">
                                <!-- Populated by JS -->
                            </div>
                            <button class="btn btn-ghost btn-sm mt-3 w-full" onclick="switchTab('guards')">
                                <span data-i18n="perf.view_all_guards">View All Guards</span>
                                <span class="material-symbols-outlined">arrow_forward</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div><!-- /perf-tab-guards -->

        <!-- TAB: Sites -->
        <div id="perf-tab-sites" class="perf-tab-content" style="display:none;">
            <!-- ===========================================
             SECTION 3: SITE ANALYTICS
             =========================================== -->
            <div class="card mb-4">
                <div class="card-header perf-section-header">
                    <div class="flex items-center gap-3">
                        <span class="perf-section-icon bg-green-100 text-green-600">
                            <span class="material-symbols-outlined">location_on</span>
                        </span>
                        <div>
                            <h3 class="font-semibold" data-i18n="perf.site_title">Site Analytics</h3>
                            <p class="text-xs text-muted" data-i18n="perf.site_sub">Coverage and visit metrics</p>
                        </div>
                    </div>
                    <div class="perf-filter-pills" id="site-route-pills">
                        <button class="perf-pill active" data-value="" onclick="filterSites('')"
                            data-i18n="perf.all_routes">All Routes</button>
                        <button class="perf-pill" data-value="A" onclick="filterSites('A')">Route A</button>
                        <button class="perf-pill" data-value="B" onclick="filterSites('B')">Route B</button>
                    </div>
                </div>
                <div class="card-content">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                        <!-- Stats Row -->
                        <div class="perf-stats-row">
                            <div class="perf-stat-card">
                                <div class="perf-stat-value" id="site-total">--</div>
                                <div class="perf-stat-label" data-i18n="perf.total_sites">Total Sites</div>
                            </div>
                            <div class="perf-stat-card">
                                <div class="perf-stat-value text-success" id="site-visited">--</div>
                                <div class="perf-stat-label" data-i18n="perf.sites_visited">Sites Visited</div>
                            </div>
                            <div class="perf-stat-card">
                                <div class="perf-stat-value text-warning" id="site-gap">--</div>
                                <div class="perf-stat-label" data-i18n="perf.coverage_gap">Coverage Gap</div>
                            </div>
                        </div>

                        <!-- Coverage Bar & Uncovered List -->
                        <div>
                            <div class="perf-coverage-bar">
                                <div class="coverage-label">
                                    <span data-i18n="perf.coverage">Coverage</span>
                                    <span id="site-coverage-pct">--%</span>
                                </div>
                                <div class="progress-bar h-3">
                                    <div class="progress-fill bg-green-500" id="site-coverage-bar" style="width: 0%">
                                    </div>
                                </div>
                            </div>
                            <div class="perf-uncovered mt-4" id="uncovered-sites-container" style="display: none;">
                                <h4 class="text-sm font-medium mb-2 text-warning">
                                    <span class="material-symbols-outlined text-sm">warning</span>
                                    <span data-i18n="perf.uncovered_sites">Uncovered Sites</span>
                                </h4>
                                <ul class="uncovered-list" id="uncovered-list">
                                    <!-- Populated by JS -->
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Route Inspection Overview Widget (Premium Stitch Design) -->
            <div class="card mb-4 polar-chart-widget">
                <div class="card-header perf-section-header">
                    <div class="flex items-center gap-3">
                        <span class="perf-section-icon"
                            style="background: linear-gradient(135deg, #6366f1, #3b82f6); color: white;">
                            <span class="material-symbols-outlined">hub</span>
                        </span>
                        <div>
                            <h3 class="font-semibold" data-i18n="perf.route_inspection_title">Route Inspection Overview
                            </h3>
                            <p class="text-xs text-muted" data-i18n="perf.route_inspection_sub">Inspection counts by
                                location</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="toggle-label text-xs" style="color: #94a3b8;" data-i18n="perf.show_legend">Show
                            Legend</label>
                        <button type="button" class="toggle-switch" id="polar-legend-toggle"
                            onclick="togglePolarLegend()">
                            <span class="toggle-knob"></span>
                        </button>
                    </div>
                </div>
                <div class="card-content" style="padding: 1.5rem;">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Route A Chart -->
                        <div class="polar-chart-container route-a">
                            <div class="polar-route-badge route-a">
                                <span class="indicator"></span>
                                <h4 class="polar-chart-title" data-i18n="perf.route_a">Route A</h4>
                            </div>
                            <div class="polar-chart-wrapper chart-glow-blue">
                                <div class="polar-chart-stats" id="route-a-stats">
                                    <span class="polar-stat-total" id="route-a-total">--</span>
                                    <span class="polar-stat-label" data-i18n="perf.total_inspections">Total
                                        Inspections</span>
                                </div>
                                <div id="route-a-chart-loading" class="polar-chart-loading">
                                    <div class="loading-spinner"></div>
                                    <span data-i18n="perf.chart_loading">Loading chart...</span>
                                </div>
                                <div id="route-a-chart-error" class="polar-chart-error" style="display:none;">
                                    <span class="material-symbols-outlined">error_outline</span>
                                    <span data-i18n="perf.chart_error">Unable to load chart</span>
                                </div>
                                <canvas id="routeAChart" style="max-height: 340px;"></canvas>
                            </div>
                        </div>
                        <!-- Route B Chart -->
                        <div class="polar-chart-container route-b">
                            <div class="polar-route-badge route-b">
                                <span class="indicator"></span>
                                <h4 class="polar-chart-title" data-i18n="perf.route_b">Route B</h4>
                            </div>
                            <div class="polar-chart-wrapper chart-glow-amber">
                                <div class="polar-chart-stats" id="route-b-stats">
                                    <span class="polar-stat-total" id="route-b-total">--</span>
                                    <span class="polar-stat-label" data-i18n="perf.total_inspections">Total
                                        Inspections</span>
                                </div>
                                <div id="route-b-chart-loading" class="polar-chart-loading">
                                    <div class="loading-spinner"></div>
                                    <span data-i18n="perf.chart_loading">Loading chart...</span>
                                </div>
                                <div id="route-b-chart-error" class="polar-chart-error" style="display:none;">
                                    <span class="material-symbols-outlined">error_outline</span>
                                    <span data-i18n="perf.chart_error">Unable to load chart</span>
                                </div>
                                <canvas id="routeBChart" style="max-height: 340px;"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Premium Footer -->
                <div class="polar-widget-footer">
                    <div class="polar-footer-status">
                        <span class="material-symbols-outlined">check_circle</span>
                        <span data-i18n="perf.last_updated">Last updated:</span>
                        <span id="polar-last-update">--</span>
                    </div>
                    <button class="btn btn-ghost btn-sm" onclick="initRouteInspectionCharts()" style="color: #94a3b8;">
                        <span class="material-symbols-outlined" style="font-size: 16px;">refresh</span>
                        <span data-i18n="common.refresh">Refresh</span>
                    </button>
                </div>
            </div>
        </div><!-- /perf-tab-sites -->


        <!-- TAB: Issues -->
        <div id="perf-tab-issues" class="perf-tab-content" style="display:none;">
            <!-- ===========================================
             SECTION 4: ISSUE TRACKER
             =========================================== -->
            <div class="card mb-4">
                <div class="card-header perf-section-header">
                    <div class="flex items-center gap-3">
                        <span class="perf-section-icon bg-red-100 text-red-600">
                            <span class="material-symbols-outlined">report_problem</span>
                        </span>
                        <div>
                            <h3 class="font-semibold" data-i18n="perf.issue_title">Issue Tracker</h3>
                            <p class="text-xs text-muted" data-i18n="perf.issue_sub">Incidents and complaints
                                tracking
                            </p>
                        </div>
                    </div>
                    <div class="perf-filter-pills" id="issue-type-pills">
                        <button class="perf-pill active" data-value="" onclick="filterPerfIssues('')"
                            data-i18n="perf.all_types">All Types</button>
                        <button class="perf-pill" data-value="incidents" onclick="filterPerfIssues('incidents')"
                            data-i18n="perf.incidents">Incidents</button>
                        <button class="perf-pill" data-value="complaints" onclick="filterPerfIssues('complaints')"
                            data-i18n="perf.complaints">Complaints</button>
                    </div>
                </div>
                <div class="card-content">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                        <!-- Stats Row -->
                        <div class="perf-stats-row">
                            <div class="perf-stat-card">
                                <div class="perf-stat-value text-danger" id="issue-open">--</div>
                                <div class="perf-stat-label" data-i18n="perf.open_issues">Open Issues</div>
                            </div>
                            <div class="perf-stat-card">
                                <div class="perf-stat-value text-success" id="issue-sla">--<small>%</small></div>
                                <div class="perf-stat-label" data-i18n="perf.sla_met">SLA Met</div>
                            </div>
                            <div class="perf-stat-card">
                                <div class="perf-stat-value" id="issue-resolution">--<small>h</small></div>
                                <div class="perf-stat-label" data-i18n="perf.avg_resolution">Avg Resolution</div>
                            </div>
                        </div>

                        <!-- 7-Day Trend -->
                        <div class="perf-trend-chart">
                            <h4 class="text-sm font-medium mb-3" data-i18n="perf.7day_trend">7-Day Issue Trend</h4>
                            <div class="trend-bars" id="issue-trend-bars">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                    </div>

                    <!-- Recent Issues Timeline -->
                    <div class="perf-timeline mt-4">
                        <h4 class="text-sm font-medium mb-3" data-i18n="perf.recent_issues">Recent Issues</h4>
                        <div class="timeline-list" id="issue-timeline">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
            </div>
        </div><!-- /perf-tab-issues -->

        <!-- TAB: Handovers -->
        <div id="perf-tab-handovers" class="perf-tab-content" style="display:none;">
            <div class="card mb-4">
                <div class="card-header perf-section-header">
                    <div class="flex items-center gap-3">
                        <span class="perf-section-icon bg-purple-100 text-purple-600">
                            <span class="material-symbols-outlined">swap_horiz</span>
                        </span>
                        <div>
                            <h3 class="font-semibold" data-i18n="perf.handover_title">Handover Records</h3>
                            <p class="text-xs text-muted" data-i18n="perf.handover_sub">Shift transition quality
                                metrics
                            </p>
                        </div>
                    </div>
                </div>
                <div class="card-content">
                    <div class="perf-stats-row">
                        <div class="perf-stat-card">
                            <div class="perf-stat-value" id="handover-total">--</div>
                            <div class="perf-stat-label" data-i18n="perf.total_handovers">Total Handovers</div>
                        </div>
                        <div class="perf-stat-card">
                            <div class="perf-stat-value" id="handover-avg-day">--</div>
                            <div class="perf-stat-label" data-i18n="perf.avg_per_day">Avg / Day</div>
                        </div>
                        <div class="perf-stat-card">
                            <div class="perf-stat-value" id="handover-completeness">--%</div>
                            <div class="perf-stat-label" data-i18n="perf.completeness_rate">Completeness Rate</div>
                            <div class="perf-stat-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill bg-purple-500" id="handover-completeness-bar"
                                        style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div><!-- /perf-tab-handovers -->

        <!-- TAB: Special Duty -->
        <div id="perf-tab-special" class="perf-tab-content" style="display:none;">
            <div class="card mb-4">
                <div class="card-header perf-section-header">
                    <div class="flex items-center gap-3">
                        <span class="perf-section-icon bg-amber-100 text-amber-600">
                            <span class="material-symbols-outlined">star</span>
                        </span>
                        <div>
                            <h3 class="font-semibold" data-i18n="perf.special_title">Special Duty</h3>
                            <p class="text-xs text-muted" data-i18n="perf.special_sub">Stationary and onboarding
                                activities</p>
                        </div>
                    </div>
                </div>
                <div class="card-content">
                    <div class="perf-stats-row">
                        <div class="perf-stat-card">
                            <div class="perf-stat-value text-danger" id="special-stationary">--</div>
                            <div class="perf-stat-label" data-i18n="perf.stationary_count">Stationary</div>
                        </div>
                        <div class="perf-stat-card">
                            <div class="perf-stat-value text-success" id="special-onboarding">--</div>
                            <div class="perf-stat-label" data-i18n="perf.onboarding_count">Onboarding</div>
                        </div>
                        <div class="perf-stat-card">
                            <div class="perf-stat-value" id="special-hours">--<small>h</small></div>
                            <div class="perf-stat-label" data-i18n="perf.total_hours">Total Hours</div>
                        </div>
                    </div>
                </div>
            </div>
        </div><!-- /perf-tab-special -->

    </div><!-- /perf-content -->

    <!-- Scatter Tooltip -->
    <div id="scatter-tooltip" class="scatter-tooltip hidden">
        <div class="tooltip-date" id="tooltip-date"></div>
        <div class="tooltip-content" id="tooltip-content"></div>
    </div>

</div>

<script>
    // ===========================================
    // PERFORMANCE PAGE STATE
    // ===========================================
    let perfData = null;
    let perfDateRange = null;
    let perfFilters = {
        inspectionRoute: '',
        guardShift: '',
        siteRoute: '',
        issueType: ''
    };
    let scatterInterval = 'day';
    let scatterTypeFilter = 'all'; // 'all', 'inspection', 'stationary', 'onboarding'
    let flatpickrPerf = null;

    // NEW: Multi-select filter state
    let selectedSites = []; // Array of selected site IDs for multi-select
    let selectedInspector = ''; // Selected inspector name
    let sitesList = []; // Cached list of sites for dropdown
    let inspectorsList = []; // Cached list of inspectors for dropdown
    let currentPerfTab = 'inspections'; // Current active tab

    // ===========================================
    // TAB NAVIGATION
    // ===========================================
    function switchPerfTab(tabId) {
        // Hide all tab contents
        document.querySelectorAll('#perf-content .perf-tab-content').forEach(function (el) {
            el.style.display = 'none';
        });

        // Show selected tab
        var targetTab = document.getElementById('perf-tab-' + tabId);
        if (targetTab) {
            targetTab.style.display = 'block';
        }

        // Update tab button states
        document.querySelectorAll('.perf-tab').forEach(function (btn) {
            btn.classList.remove('active');
        });
        document.querySelectorAll('.perf-more-item').forEach(function (btn) {
            btn.classList.remove('active');
        });

        // Activate clicked tab
        var tabBtn = document.querySelector('.perf-tab[data-tab="' + tabId + '"]');
        if (tabBtn) {
            tabBtn.classList.add('active');
        }

        // Check if it's a "More" tab
        var moreBtn = document.querySelector('.perf-more-item[data-tab="' + tabId + '"]');
        if (moreBtn) {
            moreBtn.classList.add('active');
            // Also activate the "More" button when a sub-item is active
            var moreToggle = document.querySelector('.perf-tab-more .perf-tab');
            if (moreToggle) moreToggle.classList.add('active');
        }

        // Close the More menu
        closePerfMoreMenu();

        // Store current tab
        currentPerfTab = tabId;

        // No-op: old AI panel removed (replaced by AI tab)

        // Render tab-specific content if needed
        renderTabData(tabId);

        // Initialize polar charts when Sites tab is activated
        if (tabId === 'sites') {
            initRouteInspectionCharts();
        }
    }


    function togglePerfMoreMenu() {
        var menu = document.getElementById('perf-more-menu');
        if (menu) {
            menu.classList.toggle('hidden');
        }
    }

    function closePerfMoreMenu() {
        var menu = document.getElementById('perf-more-menu');
        if (menu) {
            menu.classList.add('hidden');
        }
    }

    function renderTabData(tabId) {
        if (!perfData) return;

        switch (tabId) {
            case 'handovers':
                renderHandoverSection(perfData.handovers);
                break;
            case 'special':
                renderSpecialDutySection(perfData.specialDuties);
                break;
        }
    }

    // Close More menu when clicking outside
    document.addEventListener('click', function (e) {
        if (!e.target.closest('.perf-tab-more')) {
            closePerfMoreMenu();
        }
    });

    // ===========================================
    // INITIALIZATION
    // ===========================================
    function initPerformancePage() {
        // Initialize date picker for current month
        const now = new Date();
        const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
        const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);

        perfDateRange = {
            start: startOfMonth.toISOString().split('T')[0],
            end: endOfMonth.toISOString().split('T')[0]
        };

        // Initialize flatpickr
        if (typeof flatpickr !== 'undefined') {
            flatpickrPerf = flatpickr('#perf-date-range', {
                mode: 'range',
                dateFormat: 'M d',
                defaultDate: [startOfMonth, endOfMonth],
                maxDate: 'today',
                static: false,
                appendTo: document.body,
                positionElement: document.getElementById('perf-date-btn'),
                onChange: function (selectedDates) {
                    // Update button label
                    var label = document.getElementById('perf-date-label');
                    if (label && selectedDates.length === 2) {
                        var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                        var s = selectedDates[0];
                        var e = selectedDates[1];
                        label.textContent = months[s.getMonth()] + ' ' + s.getDate() + ' - ' + months[e.getMonth()] + ' ' + e.getDate();
                    }
                },
                onClose: function (selectedDates) {
                    if (selectedDates.length === 2) {
                        perfDateRange = {
                            start: selectedDates[0].toISOString().split('T')[0],
                            end: selectedDates[1].toISOString().split('T')[0]
                        };
                        loadPerformanceData();
                    }
                }
            });
        }

        loadPerformanceData();
    }

    // ===========================================
    // DATA LOADING (Layer 2: Non-destructive refresh)
    // ===========================================
    function loadPerformanceData() {
        var isFirstLoad = !perfData;

        if (isFirstLoad) {
            // First load: show full skeleton spinner (content is empty anyway)
            document.getElementById('perf-loading').style.display = 'block';
            document.getElementById('perf-content').style.display = 'none';
        } else {
            // Date change / refresh: keep content visible, show subtle overlay
            showPageRefresh('perf-content');
        }

        google.script.run
            .withSuccessHandler(function (data) {
                if (isFirstLoad) {
                    document.getElementById('perf-loading').style.display = 'none';
                    document.getElementById('perf-content').style.display = 'block';
                } else {
                    hidePageRefresh('perf-content');
                }
                handlePerformanceData(data);
            })
            .withFailureHandler(function (error) {
                if (isFirstLoad) {
                    document.getElementById('perf-loading').style.display = 'none';
                    document.getElementById('perf-content').style.display = 'block';
                } else {
                    hidePageRefresh('perf-content');
                }
                handlePerformanceError(error);
            })
            .getAllPerformanceData(perfDateRange);
    }

    function handlePerformanceData(data) {
        if (data.error) {
            showToast('Error loading performance data', 'error');
            return;
        }

        perfData = data;
        renderAllSections();
    }

    function handlePerformanceError(error) {
        showToast('Failed to load performance data: ' + error.message, 'error');
    }

    // ===========================================
    // RENDER ALL SECTIONS
    // ===========================================
    function renderAllSections() {
        if (!perfData) return;

        renderInspectionSection(perfData.inspections);
        renderGuardSection(perfData.guards);
        renderSiteSection(perfData.sites);
        renderIssueSection(perfData.issues);
        renderHandoverSection(perfData.handovers);
        renderSpecialDutySection(perfData.specialDuties);
        refreshScatterChart();
    }

    // ===========================================
    // SECTION 5: HANDOVERS
    // ===========================================
    function renderHandoverSection(data) {
        if (!data) {
            data = { total: 0, avgPerDay: 0, completenessRate: 0 };
        }

        var totalEl = document.getElementById('handover-total');
        var avgDayEl = document.getElementById('handover-avg-day');
        var completenessEl = document.getElementById('handover-completeness');
        var barEl = document.getElementById('handover-completeness-bar');

        if (totalEl) totalEl.textContent = data.total || 0;
        if (avgDayEl) avgDayEl.textContent = data.avgPerDay || 0;
        if (completenessEl) completenessEl.textContent = (data.completenessRate || 0) + '%';
        if (barEl) barEl.style.width = (data.completenessRate || 0) + '%';
    }

    // ===========================================
    // SECTION 6: SPECIAL DUTY
    // ===========================================
    function renderSpecialDutySection(data) {
        if (!data) {
            data = { stationary: 0, onboarding: 0, totalHours: 0 };
        }

        var stationaryEl = document.getElementById('special-stationary');
        var onboardingEl = document.getElementById('special-onboarding');
        var hoursEl = document.getElementById('special-hours');

        if (stationaryEl) stationaryEl.textContent = data.stationary || 0;
        if (onboardingEl) onboardingEl.textContent = data.onboarding || 0;
        if (hoursEl) hoursEl.innerHTML = (data.totalHours || 0) + '<small>h</small>';
    }

    // ===========================================
    // SECTION 1: INSPECTIONS
    // ===========================================
    function renderInspectionSection(data) {
        if (!data) return;

        // Existing KPIs
        document.getElementById('insp-total').textContent = data.total || 0;


        // Trend indicator
        const trend = data.trend || 0;
        const trendEl = document.getElementById('insp-trend');
        const trendIcon = trend >= 0 ? 'trending_up' : 'trending_down';
        const trendClass = trend >= 0 ? 'text-success' : 'text-danger';
        trendEl.className = 'perf-stat-trend ' + trendClass;
        trendEl.innerHTML = '<span class="material-symbols-outlined">' + trendIcon + '</span><span>' + (trend >= 0 ? '+' : '') + trend + '%</span>';

        // NEW V2 KPI 4: Avg/Day
        const avgDayEl = document.getElementById('insp-avg-day');
        if (avgDayEl) {
            avgDayEl.textContent = data.avgPerDay || 0;
        }

        // NEW V2 KPI 5: Compliance Rate with dynamic badge
        const complianceEl = document.getElementById('insp-compliance');
        const complianceStatusEl = document.getElementById('insp-compliance-status');
        if (complianceEl) {
            const rate = data.complianceRate || 0;
            complianceEl.textContent = rate + '%';

            // Dynamic badge based on compliance rate
            if (complianceStatusEl) {
                let badgeClass = 'badge-success';
                let badgeIcon = 'check_circle';
                let badgeText = t('perf.consistent') || 'Consistent';

                if (rate < 50) {
                    badgeClass = 'badge-danger';
                    badgeIcon = 'warning';
                    badgeText = t('perf.needs_attention') || 'Needs Attention';
                } else if (rate < 80) {
                    badgeClass = 'badge-warning';
                    badgeIcon = 'schedule';
                    badgeText = t('perf.moderate') || 'Moderate';
                }

                complianceStatusEl.className = 'badge ' + badgeClass;
                complianceStatusEl.innerHTML = '<span class="material-symbols-outlined text-xs">' + badgeIcon + '</span><span>' + badgeText + '</span>';
            }
        }

        // NEW V2 KPI 6: Most Active Shift with color
        const activeShiftEl = document.getElementById('insp-active-shift');
        const shiftTimeEl = document.getElementById('insp-shift-time');
        if (activeShiftEl) {
            const shift = data.mostActiveShift || 1;
            activeShiftEl.textContent = (t('perf.shift') || 'Shift') + ' ' + shift;
            activeShiftEl.className = 'perf-stat-value perf-shift-highlight perf-shift-' + shift;

            // Shift time ranges
            const shiftTimes = {
                1: '06:00 - 14:00',
                2: '14:00 - 22:00',
                3: '22:00 - 06:00'
            };
            if (shiftTimeEl) {
                shiftTimeEl.textContent = shiftTimes[shift] || '--:-- - --:--';
                shiftTimeEl.className = 'perf-stat-sublabel perf-shift-' + shift;
            }
        }
    }

    function filterPerfInspections(route) {
        perfFilters.inspectionRoute = route;
        updateFilterPills('inspection-route-pills', route);

        // Update inspection KPI cards (route-specific metrics)
        if (!perfData || !perfData.inspections || !perfData.inspections.scatterData) {
            // No cached data yet, need to fetch from backend
            google.script.run
                .withSuccessHandler(function (data) {
                    perfData.inspections = data;
                    renderInspectionSection(data);
                    // Use unified scatter refresh (applies all filters to combinedScatterData)
                    refreshScatterChart();
                    updateInspectorsList(perfData.combinedScatterData || data.scatterData || []);
                })
                .getInspectionPerformance(perfDateRange, route);
            return;
        }

        // Client-side: update KPI cards with route-filtered inspection data
        var allInspectionData = perfData.inspections.allScatterData || perfData.inspections.scatterData;
        if (!perfData.inspections.allScatterData) {
            perfData.inspections.allScatterData = perfData.inspections.scatterData;
        }

        // Re-render scatter with all filters applied via unified function
        refreshScatterChart();
        updateInspectorsList(perfData.combinedScatterData || allInspectionData || []);
    }

    // ===========================================
    // ROUTE FILTER (Dropdown)
    // ===========================================
    var selectedRoute = '';

    function togglePerfRouteSelect() {
        var selectContainer = document.getElementById('perfRouteSelect-select');
        if (!selectContainer) return;

        // Close other custom selects
        closeAllPerfDropdowns('perfRouteSelect-select');

        // Toggle this one
        selectContainer.classList.toggle('open');
    }

    function selectPerfRoute(route) {
        selectedRoute = route;

        // Update label
        var label = document.getElementById('perfRouteSelectLabel');
        if (label) {
            var lang = localStorage.getItem('language') || 'en';
            var dict = (typeof I18N !== 'undefined' && I18N[lang]) ? I18N[lang] : {};
            if (route === '') {
                label.textContent = dict['perf.all_routes'] || 'All Routes';
            } else if (route === 'A') {
                label.textContent = dict['perf.route_a'] || 'Route A';
            } else if (route === 'B') {
                label.textContent = dict['perf.route_b'] || 'Route B';
            }
        }

        // Re-render options with checkmarks
        renderRouteFilterOptions();

        // Close dropdown
        var selectContainer = document.getElementById('perfRouteSelect-select');
        if (selectContainer) selectContainer.classList.remove('open');

        // Apply filter
        filterPerfInspections(route);
    }

    function renderRouteFilterOptions() {
        var optionsContainer = document.getElementById('perfRouteSelect-options');
        if (!optionsContainer) return;

        var lang = localStorage.getItem('language') || 'en';
        var dict = (typeof I18N !== 'undefined' && I18N[lang]) ? I18N[lang] : {};

        var routes = [
            { value: '', label: dict['perf.all_routes'] || 'All Routes' },
            { value: 'A', label: dict['perf.route_a'] || 'Route A' },
            { value: 'B', label: dict['perf.route_b'] || 'Route B' }
        ];

        var html = '';
        routes.forEach(function (r) {
            var isSelected = selectedRoute === r.value;
            html += '<div class="custom-select-item' + (isSelected ? ' selected' : '') + '" ' +
                'data-value="' + r.value + '" onclick="selectPerfRoute(\'' + r.value + '\')">' +
                '<span>' + r.label + '</span></div>';
        });

        optionsContainer.innerHTML = html;
    }

    // Initialize route filter options on page load
    setTimeout(function () { renderRouteFilterOptions(); }, 100);

    function closeAllPerfDropdowns(exceptId) {
        var dropdowns = ['perfRouteSelect-select', 'perfSiteSelect-select', 'perfInspectorSelect-select'];
        dropdowns.forEach(function (id) {
            if (id !== exceptId) {
                var el = document.getElementById(id);
                if (el) el.classList.remove('open');
            }
        });
    }

    // ===========================================
    // SITE FILTER (Multi-select)
    // ===========================================
    function togglePerfSiteSelect() {
        var selectContainer = document.getElementById('perfSiteSelect-select');
        if (!selectContainer) return;

        // Close other custom selects in Performance page
        closeAllPerfDropdowns('perfSiteSelect-select');

        // Toggle this one
        selectContainer.classList.toggle('open');

        // Load sites on first open if not loaded
        if (selectContainer.classList.contains('open') && sitesList.length === 0) {
            loadSitesForFilter();
        }
    }

    function loadSitesForFilter() {
        var optionsContainer = document.getElementById('perfSiteSelect-options');
        if (!optionsContainer) return;

        optionsContainer.innerHTML = '<div class="custom-select-item text-muted">Loading...</div>';

        google.script.run
            .withSuccessHandler(function (sites) {
                sitesList = sites || [];
                renderSiteFilterOptions();
            })
            .withFailureHandler(function (err) {
                optionsContainer.innerHTML = '<div class="custom-select-item text-danger">Failed to load</div>';
            })
            .getSites({ status: 'active' });
    }

    function renderSiteFilterOptions() {
        var optionsContainer = document.getElementById('perfSiteSelect-options');
        if (!optionsContainer) return;

        var html = '<div class="p-2 sticky top-0 bg-white border-b border-gray-100 z-10">' +
            '<input type="text" class="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg focus:outline-none focus:border-blue-500" ' +
            'placeholder="Search sites..." onkeyup="filterSiteOptions(this.value)"></div>';

        html += '<div class="custom-select-item" onclick="event.stopPropagation(); clearSiteFilter()">' +
            '<span class="material-symbols-outlined text-sm" style="margin-right:6px;color:' + (selectedSites.length === 0 ? 'var(--primary)' : 'var(--text-secondary)') + ';">' +
            (selectedSites.length === 0 ? 'check_box' : 'check_box_outline_blank') + '</span>' +
            '<span data-i18n="perf.all_sites" style="' + (selectedSites.length === 0 ? 'color:var(--primary);font-weight:500;' : '') + '">All Sites</span></div>';

        sitesList.forEach(function (site) {
            var isSelected = selectedSites.indexOf(site.id) !== -1;
            var checkIcon = isSelected ? 'check_box' : 'check_box_outline_blank';
            html += '<div class="custom-select-item" ' +
                'data-value="' + site.id + '" onclick="event.stopPropagation(); toggleSiteSelection(\'' + site.id + '\')">' +
                '<span class="material-symbols-outlined text-sm" style="margin-right:6px;color:' + (isSelected ? 'var(--primary)' : 'var(--text-secondary)') + ';">' + checkIcon + '</span>' +
                '<span style="' + (isSelected ? 'color:var(--primary);font-weight:500;' : '') + '">' + escapeHtml(site.nameEN || site.name || site.id) + '</span></div>';
        });

        optionsContainer.innerHTML = html;
    }

    function toggleSiteSelection(siteId) {
        var index = selectedSites.indexOf(siteId);
        if (index === -1) {
            selectedSites.push(siteId);
        } else {
            selectedSites.splice(index, 1);
        }

        renderSiteFilterOptions();
        updateSiteFilterLabel();
        applyScatterFilters();

        // Ensure dropdown stays open after re-render
        var selectContainer = document.getElementById('perfSiteSelect-select');
        if (selectContainer) selectContainer.classList.add('open');
    }

    function clearSiteFilter() {
        selectedSites = [];
        renderSiteFilterOptions();
        updateSiteFilterLabel();
        applyScatterFilters();
        // Close dropdown after clearing
        var selectContainer = document.getElementById('perfSiteSelect-select');
        if (selectContainer) selectContainer.classList.remove('open');
    }

    function filterSiteOptions(query) {
        var term = query.toLowerCase();
        var items = document.querySelectorAll('#perfSiteSelect-options .custom-select-item');
        items.forEach(function (item) {
            // Skip the "All Sites" option (usually first or has specific click handler) or check for data-value
            if (!item.hasAttribute('data-value')) return;

            var text = item.textContent.toLowerCase();
            if (text.indexOf(term) > -1) {
                item.style.display = 'flex';
            } else {
                item.style.display = 'none';
            }
        });
    }

    function updateSiteFilterLabel() {
        var label = document.getElementById('perfSiteSelectLabel');
        var badge = document.getElementById('perfSiteCount');
        if (!label) return;

        if (selectedSites.length === 0) {
            label.textContent = t('perf.all_sites') || 'All Sites';
            if (badge) badge.classList.add('hidden');
        } else if (selectedSites.length === 1) {
            var site = sitesList.find(function (s) { return s.id === selectedSites[0]; });
            label.textContent = site ? (site.nameEN || site.name || site.id) : selectedSites[0];
            if (badge) badge.classList.add('hidden');
        } else {
            label.textContent = t('perf.multi_sites') || 'Multiple';
            if (badge) {
                badge.textContent = selectedSites.length;
                badge.classList.remove('hidden');
            }
        }
    }

    // ===========================================
    // INSPECTOR FILTER
    // ===========================================
    function togglePerfInspectorSelect() {
        var selectContainer = document.getElementById('perfInspectorSelect-select');
        if (!selectContainer) return;

        // Close other dropdowns
        closeAllPerfDropdowns('perfInspectorSelect-select');

        // Toggle this one
        selectContainer.classList.toggle('open');

        // Populate from scatter data on first open if not loaded
        if (selectContainer.classList.contains('open') && inspectorsList.length === 0) {
            loadInspectorsFromScatterData();
        }
    }

    function loadInspectorsFromScatterData() {
        // Extract inspectors from already-loaded scatter data
        if (!perfData || !perfData.inspections || !perfData.inspections.scatterData) {
            // Data not loaded yet, show loading and retry
            var optionsContainer = document.getElementById('perfInspectorSelect-options');
            if (optionsContainer) {
                optionsContainer.innerHTML = '<div class="custom-select-item text-muted">Loading...</div>';
            }
            // Retry after delay
            setTimeout(loadInspectorsFromScatterData, 500);
            return;
        }

        // Use updateInspectorsList to extract from scatter data
        updateInspectorsList(perfData.inspections.scatterData);
    }

    function updateInspectorsList(scatterData) {
        // Extract unique inspectors from scatter data
        var inspectorsMap = {};
        (scatterData || []).forEach(function (d) {
            if (d.inspector && d.inspector.trim()) {
                inspectorsMap[d.inspector.trim()] = true;
            } else if (d.GuardName && d.GuardName.trim()) { // Fallback for some data structures
                inspectorsMap[d.GuardName.trim()] = true;
            }
        });
        inspectorsList = Object.keys(inspectorsMap).sort();
        renderInspectorFilterOptions();
    }

    function renderInspectorFilterOptions() {
        var optionsContainer = document.getElementById('perfInspectorSelect-options');
        if (!optionsContainer) return;

        // Clear and rebuild using DOM (V2 pattern)
        optionsContainer.innerHTML = '';

        // Add "All Inspectors" option
        var allOpt = document.createElement('div');
        allOpt.className = 'custom-select-item' + (selectedInspector === '' ? ' selected' : '');
        allOpt.dataset.value = '';
        allOpt.textContent = t('perf.all_inspectors') || 'All Inspectors';
        allOpt.onclick = function () { selectInspector(''); };
        optionsContainer.appendChild(allOpt);

        // Add each inspector
        inspectorsList.forEach(function (inspector) {
            var opt = document.createElement('div');
            opt.className = 'custom-select-item' + (selectedInspector === inspector ? ' selected' : '');
            opt.dataset.value = inspector;
            opt.textContent = inspector;
            opt.onclick = function () { selectInspector(inspector); };
            optionsContainer.appendChild(opt);
        });
    }

    function selectInspector(inspector) {
        selectedInspector = inspector;

        var label = document.getElementById('perfInspectorSelectLabel');
        if (label) {
            label.textContent = inspector || (t('perf.all_inspectors') || 'All Inspectors');
        }

        renderInspectorFilterOptions();
        // Close dropdown after selection
        var selectContainer = document.getElementById('perfInspectorSelect-select');
        if (selectContainer) selectContainer.classList.remove('open');

        applyScatterFilters();
    }

    // ===========================================
    // UNIFIED SCATTER REFRESH (applies ALL active filters)
    // ===========================================
    function refreshScatterChart() {
        if (!perfData) return;

        var allData = perfData.combinedScatterData || perfData.inspections?.scatterData || [];
        var filteredData = allData;

        // 1. Apply route filter (only to inspection-type points;
        //    stationary/onboarding are not route-specific, so they pass through)
        if (perfFilters.inspectionRoute) {
            var route = perfFilters.inspectionRoute;
            filteredData = filteredData.filter(function (d) {
                var t = (d.type || '').toLowerCase();
                // Non-inspection types (stationary, onboarding) are not route-specific ‚Äî always show
                if (t === 'stationary' || t === 'onboarding') return true;
                // Inspection types: filter by route
                return d.route === route || d.routeName === route ||
                    (d.siteName && d.siteName.includes('Route ' + route));
            });
        }

        // 2. Apply site filter
        if (selectedSites.length > 0) {
            filteredData = filteredData.filter(function (d) {
                return selectedSites.some(function (sId) {
                    var site = sitesList.find(function (s) { return s.id === sId; });
                    if (!site) return false;
                    var scatterSiteName = (d.siteName || '').toLowerCase();
                    var siteNameEN = (site.nameEN || '').toLowerCase();
                    var siteName = (site.name || '').toLowerCase();
                    return scatterSiteName === siteNameEN || scatterSiteName === siteName ||
                        scatterSiteName.includes(siteNameEN) || siteNameEN.includes(scatterSiteName);
                });
            });
        }

        // 3. Apply inspector filter
        if (selectedInspector) {
            filteredData = filteredData.filter(function (d) {
                return d.inspector === selectedInspector;
            });
        }

        // 4. Type filter is applied inside renderScatterChart() via scatterTypeFilter
        renderScatterChart(filteredData);
    }

    // Backwards-compatible alias
    function applyScatterFilters() { refreshScatterChart(); }

    function closeAllPerfDropdowns(exceptId) {
        var selects = document.querySelectorAll('#page-performance .custom-select.open');
        selects.forEach(function (s) {
            if (!exceptId || s.id !== exceptId) {
                s.classList.remove('open');
            }
        });
    }

    // Close dropdowns on outside click
    document.addEventListener('click', function (e) {
        if (!e.target.closest('.custom-select')) {
            closeAllPerfDropdowns();
        }
    });

    // ===========================================
    // SECTION 2: GUARDS
    // ===========================================
    function renderGuardSection(data) {
        if (!data) return;

        document.getElementById('guard-active').textContent = data.activeGuards || 0;
        document.getElementById('guard-ontime').innerHTML = (data.onTimeRate || 0) + '<small>%</small>';
        document.getElementById('guard-ontime-bar').style.width = (data.onTimeRate || 0) + '%';
        document.getElementById('guard-scans').textContent = data.avgScansPerDay || 0;

        // Leaderboard
        const leaderboard = document.getElementById('guard-leaderboard');
        const performers = data.topPerformers || [];

        if (performers.length === 0) {
            leaderboard.innerHTML = '<p class="text-muted text-sm">No data available</p>';
            return;
        }

        leaderboard.innerHTML = performers.map((p, i) => {
            const rankClass = i === 0 ? 'gold' : (i === 1 ? 'silver' : 'bronze');
            return '<div class="leaderboard-item" onclick="openGuardModal(\'' + p.guardId + '\')">' +
                '<span class="rank-badge ' + rankClass + '">#' + (i + 1) + '</span>' +
                '<span class="name">' + escapeHtml(p.name) + '</span>' +
                '<span class="score">' + p.onTimeRate + '% <small>(' + p.totalScans + ' scans)</small></span>' +
                '</div>';
        }).join('');
    }

    function filterPerfGuards(shift) {
        perfFilters.guardShift = shift;
        updateFilterPills('guard-shift-pills', shift);

        google.script.run
            .withSuccessHandler(function (data) {
                perfData.guards = data;
                renderGuardSection(data);
            })
            .getGuardPerformance(perfDateRange, shift);
    }

    // ===========================================
    // SECTION 3: SITES
    // ===========================================
    function renderSiteSection(data) {
        if (!data) return;

        document.getElementById('site-total').textContent = data.totalSites || 0;
        document.getElementById('site-visited').textContent = data.visitedSites || 0;
        document.getElementById('site-gap').textContent = data.coverageGap || 0;
        document.getElementById('site-coverage-pct').textContent = (data.coveragePercent || 0) + '%';
        document.getElementById('site-coverage-bar').style.width = (data.coveragePercent || 0) + '%';

        // Uncovered sites list
        const container = document.getElementById('uncovered-sites-container');
        const list = document.getElementById('uncovered-list');
        const uncovered = data.uncovered || [];

        if (uncovered.length > 0) {
            container.style.display = 'block';
            list.innerHTML = uncovered.map(s =>
                '<li><span class="site-name">' + escapeHtml(s.name) + '</span>' +
                '<span class="site-route badge badge-ghost">' + (s.route || '-') + '</span></li>'
            ).join('');
        } else {
            container.style.display = 'none';
        }
    }

    function filterSites(route) {
        perfFilters.siteRoute = route;
        updateFilterPills('site-route-pills', route);

        google.script.run
            .withSuccessHandler(function (data) {
                perfData.sites = data;
                renderSiteSection(data);
            })
            .getSitePerformance(perfDateRange, route);
    }

    // ===========================================
    // POLAR AREA CHARTS (Route A/B)
    // ===========================================
    let routeAChart = null;
    let routeBChart = null;
    let polarLegendVisible = false;

    function initRouteInspectionCharts() {
        // Show loading, hide error
        const loadingA = document.getElementById('route-a-chart-loading');
        const loadingB = document.getElementById('route-b-chart-loading');
        const errorA = document.getElementById('route-a-chart-error');
        const errorB = document.getElementById('route-b-chart-error');
        const canvasA = document.getElementById('routeAChart');
        const canvasB = document.getElementById('routeBChart');

        if (loadingA) loadingA.style.display = 'flex';
        if (loadingB) loadingB.style.display = 'flex';
        if (errorA) errorA.style.display = 'none';
        if (errorB) errorB.style.display = 'none';
        if (canvasA) canvasA.style.display = 'none';
        if (canvasB) canvasB.style.display = 'none';

        google.script.run
            .withSuccessHandler(function (data) {
                if (loadingA) loadingA.style.display = 'none';
                if (loadingB) loadingB.style.display = 'none';

                if (!data || (!data.routeA.length && !data.routeB.length)) {
                    if (errorA) errorA.style.display = 'flex';
                    if (errorB) errorB.style.display = 'flex';
                    return;
                }

                // Update totals
                document.getElementById('route-a-total').textContent = data.routeATotal || 0;
                document.getElementById('route-b-total').textContent = data.routeBTotal || 0;

                // Render charts
                renderPolarChart('routeAChart', data.routeA, 'blue');
                renderPolarChart('routeBChart', data.routeB, 'orange');

                // Update last updated timestamp
                const updateEl = document.getElementById('polar-last-update');
                if (updateEl) {
                    const now = new Date();
                    updateEl.textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                }
            })

            .withFailureHandler(function (err) {
                console.error('getRouteInspectionCounts error:', err);
                if (loadingA) loadingA.style.display = 'none';
                if (loadingB) loadingB.style.display = 'none';
                if (errorA) errorA.style.display = 'flex';
                if (errorB) errorB.style.display = 'flex';
            })
            .getRouteInspectionCounts(perfDateRange);
    }

    function renderPolarChart(canvasId, siteData, colorTheme) {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return;

        canvas.style.display = 'block';

        // Destroy existing chart
        const existingChart = canvasId === 'routeAChart' ? routeAChart : routeBChart;
        if (existingChart) {
            existingChart.destroy();
        }

        // Prepare data
        const labels = siteData.map(s => {
            const name = s.siteName || '';
            return name.length > 20 ? name.substring(0, 17) + '...' : name;
        });
        const counts = siteData.map(s => s.count || 0);

        // Generate color palette
        const colors = generateColorPalette(siteData.length, colorTheme);

        const chartConfig = {
            type: 'polarArea',
            data: {
                labels: labels,
                datasets: [{
                    data: counts,
                    backgroundColor: colors.map(c => c + '99'), // 60% opacity
                    borderColor: colors,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: polarLegendVisible,
                        position: 'bottom',
                        labels: {
                            boxWidth: 12,
                            padding: 8,
                            font: { size: 10 }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            title: function (context) {
                                // Show full site name on hover
                                const idx = context[0].dataIndex;
                                return siteData[idx] ? siteData[idx].siteName : '';
                            },
                            label: function (context) {
                                return context.parsed + ' inspections';
                            }
                        }
                    }
                },
                scales: {
                    r: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 5,
                            font: { size: 10 }
                        },
                        grid: {
                            color: 'rgba(0,0,0,0.1)'
                        }
                    }
                }
            }
        };

        const ctx = canvas.getContext('2d');
        const newChart = new Chart(ctx, chartConfig);

        if (canvasId === 'routeAChart') {
            routeAChart = newChart;
        } else {
            routeBChart = newChart;
        }
    }

    function generateColorPalette(count, theme) {
        const colors = [];
        const baseHue = theme === 'blue' ? 210 : 30; // Blue: 210, Orange: 30

        for (let i = 0; i < count; i++) {
            // Vary lightness from 35% to 70%
            const lightness = 35 + (i % 8) * 5;
            // Slight hue variation for visual interest
            const hue = baseHue + (i % 5) * 3 - 6;
            colors.push(`hsl(${hue}, 70%, ${lightness}%)`);
        }
        return colors;
    }

    function togglePolarLegend() {
        const toggle = document.getElementById('polar-legend-toggle');
        polarLegendVisible = !polarLegendVisible;

        if (toggle) {
            toggle.classList.toggle('active', polarLegendVisible);
        }

        // Rebuild charts with new legend setting
        if (routeAChart || routeBChart) {
            // Re-fetch and render to apply legend change
            initRouteInspectionCharts();
        }
    }

    function destroyRouteCharts() {
        if (routeAChart) {
            routeAChart.destroy();
            routeAChart = null;
        }
        if (routeBChart) {
            routeBChart.destroy();
            routeBChart = null;
        }
    }

    // ===========================================
    // SECTION 4: ISSUES

    // ===========================================
    function renderIssueSection(data) {
        if (!data) return;

        document.getElementById('issue-open').textContent = data.openIssues || 0;
        document.getElementById('issue-sla').innerHTML = (data.slaMet || 0) + '<small>%</small>';
        document.getElementById('issue-resolution').innerHTML = (data.avgResolutionHours || 0) + '<small>h</small>';

        // 7-day trend bars
        const trendBars = document.getElementById('issue-trend-bars');
        const trend = data.trend || [];
        const maxCount = Math.max(...trend.map(t => t.count), 1);

        trendBars.innerHTML = trend.map(t => {
            const height = Math.max(10, (t.count / maxCount) * 100);
            return '<div class="trend-bar-container">' +
                '<div class="trend-bar" style="height: ' + height + '%"><span>' + t.count + '</span></div>' +
                '<span class="trend-day">' + t.day + '</span>' +
                '</div>';
        }).join('');

        // Recent issues timeline
        const timeline = document.getElementById('issue-timeline');
        const recent = data.recent || [];

        if (recent.length === 0) {
            timeline.innerHTML = '<p class="text-muted text-sm">No recent issues</p>';
            return;
        }

        timeline.innerHTML = recent.map(issue => {
            const severityClass = issue.severity === 'severe' ? 'danger' : (issue.severity === 'medium' ? 'warning' : 'success');
            const typeIcon = issue.type === 'incident' ? 'local_police' : 'feedback';
            return '<div class="timeline-item">' +
                '<span class="timeline-dot bg-' + severityClass + '"></span>' +
                '<div class="timeline-content">' +
                '<div class="timeline-header">' +
                '<span class="material-symbols-outlined text-sm">' + typeIcon + '</span>' +
                '<span class="timeline-time">' + formatTimeAgo(issue.createdAt) + '</span>' +
                '</div>' +
                '<p class="timeline-desc">' + escapeHtml(issue.description || 'No description') + '</p>' +
                '</div>' +
                '</div>';
        }).join('');
    }

    function filterPerfIssues(type) {
        perfFilters.issueType = type;
        updateFilterPills('issue-type-pills', type);

        google.script.run
            .withSuccessHandler(function (data) {
                perfData.issues = data;
                renderIssueSection(data);
            })
            .getIssuePerformance(perfDateRange, type);
    }

    // ===========================================
    // SCATTER CHART (V2-Style Implementation)
    // ===========================================
    function updateScatterHeader() {
        var titleEl = document.getElementById('scatter-header-title');
        if (!titleEl) return;

        var text = (typeof t === 'function' ? t('perf.inspection_activity') : 'Inspection Activity');

        // 1. Route
        if (perfFilters.inspectionRoute) {
            text += ' - ' + (typeof t === 'function' && t('perf.filter_route') ? t('perf.filter_route') : 'Route') + ' ' + perfFilters.inspectionRoute;
        }

        // 2. Sites (Multi-select)
        if (selectedSites && selectedSites.length > 0) {
            if (selectedSites.length === 1) {
                var site = sitesList.find(function (s) { return s.id === selectedSites[0]; });
                var siteName = site ? (site.nameEN || site.name) : selectedSites[0];
                text += ' - ' + siteName;
            } else {
                text += ' - ' + selectedSites.length + ' ' + (typeof t === 'function' && t('perf.filter_sites') ? t('perf.filter_sites') : 'Sites');
            }
        }

        // 3. Inspector
        if (selectedInspector) {
            text += ' - ' + selectedInspector;
        }

        // 4. Activity Type
        if (scatterTypeFilter && scatterTypeFilter !== 'all') {
            var typeStr = scatterTypeFilter.charAt(0).toUpperCase() + scatterTypeFilter.slice(1);
            text += ' - ' + typeStr;
        }

        // 5. Date Range (Optional - keeping concise for now as requested)
        // if (perfDateRange && perfDateRange.start) { ... }

        titleEl.textContent = text;
    }

    function renderScatterChart(data) {
        updateScatterHeader();
        var svg = document.getElementById('shiftScatterSvg');
        var xAxis = document.getElementById('shiftXAxis');
        var yAxis = document.getElementById('shiftYAxis');
        var vGrid = document.getElementById('shiftVGrid');
        var wrapper = document.getElementById('shiftGraphWrapper');

        if (!svg) return;

        // Apply type filter
        var filteredData = data;
        if (scatterTypeFilter && scatterTypeFilter !== 'all' && data && data.length > 0) {
            filteredData = data.filter(function (point) {
                if (scatterTypeFilter === 'inspection') {
                    // Inspection is any point that is NOT stationary or onboarding
                    // (includes 'regular', 'inspection', or undefined types)
                    var t = (point.type || '').toLowerCase();
                    return t !== 'stationary' && t !== 'onboarding';
                }
                return (point.type || '').toLowerCase() === scatterTypeFilter.toLowerCase();
            });
        }
        data = filteredData;

        // Handle empty data
        if (!data || data.length === 0) {
            svg.innerHTML = '<text x="50%" y="50%" text-anchor="middle" fill="#9ca3af" font-size="14">No data available</text>';
            if (xAxis) xAxis.innerHTML = '';
            if (yAxis) yAxis.innerHTML = '';
            if (vGrid) vGrid.innerHTML = '';
            return;
        }

        // Clear previous content
        svg.innerHTML = '';
        if (xAxis) xAxis.innerHTML = '';
        if (yAxis) yAxis.innerHTML = '';
        if (vGrid) vGrid.innerHTML = '';

        // Get date range from perfDateRange (user-selected), NOT from data
        // This ensures the full month is always displayed even if data is sparse
        var dateFrom, dateTo;
        if (perfDateRange && perfDateRange.start && perfDateRange.end) {
            // Parse perfDateRange - format is "YYYY-MM-DD" or "DD/MM/YYYY"
            if (perfDateRange.start.includes('/')) {
                // DD/MM/YYYY format
                var startParts = perfDateRange.start.split('/');
                var endParts = perfDateRange.end.split('/');
                dateFrom = new Date(startParts[2], startParts[1] - 1, startParts[0]);
                dateTo = new Date(endParts[2], endParts[1] - 1, endParts[0]);
            } else {
                // YYYY-MM-DD format
                dateFrom = new Date(perfDateRange.start);
                dateTo = new Date(perfDateRange.end);
            }
        } else {
            // Fallback: use current month if no date range set
            var now = new Date();
            dateFrom = new Date(now.getFullYear(), now.getMonth(), 1);
            dateTo = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        }

        var totalDays = Math.ceil((dateTo - dateFrom) / (1000 * 60 * 60 * 24)) + 1;
        var totalColumns = scatterInterval === 'week' ? Math.ceil(totalDays / 7) : totalDays;

        // Generate Y-axis labels (25 hourly: 06:00 to 06:00)
        if (yAxis) {
            var hours = [6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 0, 1, 2, 3, 4, 5, 6];
            for (var h = 0; h < hours.length; h++) {
                var label = document.createElement('span');
                label.textContent = String(hours[h]).padStart(2, '0') + ':00';
                yAxis.appendChild(label);
            }
        }

        // Generate vertical grid lines
        if (vGrid) {
            var gridCount = Math.min(totalColumns, 60);
            for (var g = 0; g < gridCount; g++) {
                var line = document.createElement('div');
                line.className = 'shift-v-grid-line';
                vGrid.appendChild(line);
            }
        }

        // Aggregate data by date for tooltips
        var dailyStats = {};
        for (var j = 0; j < data.length; j++) {
            var item = data[j];
            var dateKey = item.date;
            if (!dailyStats[dateKey]) {
                dailyStats[dateKey] = { 1: 0, 2: 0, 3: 0, stationary: 0, onboarding: 0 };
            }

            if (item.type === 'stationary') {
                dailyStats[dateKey].stationary++;
            } else if (item.type === 'onboarding') {
                dailyStats[dateKey].onboarding++;
            } else {
                dailyStats[dateKey][item.shift || 1]++;
            }
        }

        // Create invisible hover zones for aggregate tooltips
        for (var d = 0; d < totalDays; d++) {
            var zoneDate = new Date(dateFrom.getTime());
            zoneDate.setDate(zoneDate.getDate() + d);
            var zoneDateStr = zoneDate.toISOString().split('T')[0];

            var xPercent = (d / Math.max(totalDays - 1, 1)) * 100;
            var colWidth = (1 / totalDays) * 100;

            var rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            rect.setAttribute('x', Math.max(0, xPercent - colWidth / 2) + '%');
            rect.setAttribute('y', '0');
            rect.setAttribute('width', colWidth + '%');
            rect.setAttribute('height', '100%');
            rect.setAttribute('fill', 'transparent');
            rect.setAttribute('class', 'hover-zone');

            // Find matching stats (may need date format adjustment)
            var counts = { 1: 0, 2: 0, 3: 0, stationary: 0, onboarding: 0 };
            for (var dk in dailyStats) {
                if (dk === zoneDateStr || new Date(dk).toDateString() === zoneDate.toDateString()) {
                    counts = dailyStats[dk];
                    break;
                }
            }
            var dateLabel = formatScatterDateLabel(zoneDate);

            // Use IIFE to capture closure properly
            (function (lbl, cts) {
                rect.onmouseover = function (e) { showAggregateTooltip(e, lbl, cts); };
                rect.onmousemove = function (e) { moveScatterTooltip(e); };
                rect.onmouseout = function () { hideScatterTooltip(); };
            })(dateLabel, counts);

            svg.appendChild(rect);
        }

        // Draw dots
        for (var k = 0; k < data.length; k++) {
            var point = data[k];
            var pointDate = new Date(point.date);
            var dayIndex = Math.floor((pointDate - dateFrom) / (1000 * 60 * 60 * 24));

            var dotX;
            if (scatterInterval === 'week') {
                var weekIndex = Math.floor(dayIndex / 7);
                var totalWeeks = Math.ceil(totalDays / 7);
                // Use deterministic jitter based on point index + hour/minute to prevent drift
                var seed = (k * 13 + (point.hour || 0) * 7 + (point.minute || 0)) % 100;
                var jitter = ((seed - 50) / 100) * 0.6; // ¬±30% within week
                dotX = ((weekIndex + 0.5 + jitter) / Math.max(totalWeeks, 1)) * 100;
            } else {
                dotX = (dayIndex / Math.max(totalDays - 1, 1)) * 100;
            }

            var dotY = getShiftYPosition(point.hour, point.minute);

            // Determine color and size - MUST match CSS legend colors exactly
            var color = '#3b82f6'; // Default: Shift 1 Blue (blue-500)
            var radius = 4;
            var strokeWidth = 1.5;

            if (point.type === 'stationary') {
                color = '#ef4444'; // Red (red-500)
                radius = 6;
                strokeWidth = 2;
            } else if (point.type === 'onboarding') {
                color = '#10b981'; // Green (green-500)
                radius = 6;
                strokeWidth = 2;
            } else if (point.shift === 2) {
                color = '#f97316'; // Orange (orange-500) - matches .legend-dot.shift-2
            } else if (point.shift === 3) {
                color = '#8b5cf6'; // Purple (violet-500) - matches .legend-dot.shift-3
            }

            var circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            circle.setAttribute('cx', dotX + '%');
            circle.setAttribute('cy', dotY + '%');
            circle.setAttribute('r', radius);
            circle.setAttribute('fill', color);
            circle.setAttribute('class', 'shift-dot');
            circle.setAttribute('stroke', 'white');
            circle.setAttribute('stroke-width', strokeWidth);
            svg.appendChild(circle);
        }

        // X-axis labels
        if (xAxis) {
            if (scatterInterval === 'week') {
                var totalWeeks = Math.ceil(totalDays / 7);
                for (var w = 0; w < totalWeeks; w++) {
                    var weekLabel = document.createElement('span');
                    weekLabel.textContent = 'W' + (w + 1);
                    xAxis.appendChild(weekLabel);
                }
            } else if (totalDays <= 31) {
                for (var d2 = 0; d2 < totalDays; d2++) {
                    var labelDate = new Date(dateFrom.getTime());
                    labelDate.setDate(labelDate.getDate() + d2);
                    var lbl = document.createElement('span');
                    lbl.textContent = String(labelDate.getDate()).padStart(2, '0');
                    xAxis.appendChild(lbl);
                }
            } else {
                // Show every 7th day for longer ranges
                for (var d3 = 0; d3 < totalDays; d3 += 7) {
                    var markerDate = new Date(dateFrom.getTime());
                    markerDate.setDate(markerDate.getDate() + d3);
                    var markerLabel = document.createElement('span');
                    markerLabel.textContent = formatScatterDateLabel(markerDate);
                    xAxis.appendChild(markerLabel);
                }
            }
        }
    }

    // Get Y position based on shift-relative time (06:00 at top ‚Üí 06:00 at bottom)
    function getShiftYPosition(hour, minute) {
        var totalMinutes = (hour * 60 + (minute || 0)) - 360; // Offset from 06:00
        if (totalMinutes < 0) totalMinutes += 1440; // Wrap for times before 06:00
        return (totalMinutes / 1440) * 100;
    }

    function formatScatterDateLabel(date) {
        var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        return months[date.getMonth()] + ' ' + String(date.getDate()).padStart(2, '0');
    }

    function showAggregateTooltip(e, dateLabel, counts) {
        var tooltip = document.getElementById('scatter-tooltip');
        if (!tooltip) return;

        var total = (counts[1] || 0) + (counts[2] || 0) + (counts[3] || 0) + (counts.stationary || 0) + (counts.onboarding || 0);

        var html = '<div class="font-bold mb-2 pb-1" style="border-bottom: 1px solid #e5e7eb;">' + dateLabel + '</div>';
        html += '<div style="display: flex; flex-direction: column; gap: 4px;">';
        html += '<div style="display: flex; justify-content: space-between; gap: 16px;"><span>üîµ Shift 1 (06-14)</span><span>' + (counts[1] || 0) + '</span></div>';
        html += '<div style="display: flex; justify-content: space-between; gap: 16px;"><span>üü† Shift 2 (14-22)</span><span>' + (counts[2] || 0) + '</span></div>';
        html += '<div style="display: flex; justify-content: space-between; gap: 16px;"><span>üü£ Shift 3 (22-06)</span><span>' + (counts[3] || 0) + '</span></div>';
        if (counts.stationary > 0) {
            html += '<div style="display: flex; justify-content: space-between; gap: 16px; border-top: 1px solid #e5e7eb; padding-top: 4px;"><span>üî¥ Stationary</span><span>' + counts.stationary + '</span></div>';
        }
        if (counts.onboarding > 0) {
            html += '<div style="display: flex; justify-content: space-between; gap: 16px;"><span>üü¢ Onboarding</span><span>' + counts.onboarding + '</span></div>';
        }
        html += '<div style="display: flex; justify-content: space-between; gap: 16px; border-top: 1px solid #e5e7eb; padding-top: 4px; font-weight: bold;"><span>Total</span><span>' + total + '</span></div>';
        html += '</div>';

        tooltip.innerHTML = html;
        tooltip.classList.remove('hidden');
        moveScatterTooltip(e);
    }

    function moveScatterTooltip(e) {
        var tooltip = document.getElementById('scatter-tooltip');
        if (tooltip) {
            tooltip.style.left = (e.clientX + 12) + 'px';
            tooltip.style.top = (e.clientY - 12) + 'px';
        }
    }

    function hideScatterTooltip() {
        var tooltip = document.getElementById('scatter-tooltip');
        if (tooltip) tooltip.classList.add('hidden');
    }

    function toggleScatterInterval(interval) {
        scatterInterval = interval;
        document.getElementById('scatter-day-btn').classList.toggle('active', interval === 'day');
        document.getElementById('scatter-week-btn').classList.toggle('active', interval === 'week');
        // Re-render with all filters preserved
        refreshScatterChart();
    }

    function toggleScatterFullscreen() {
        var container = document.getElementById('scatter-chart-container');
        if (!container) {
            showToast('Chart container not found', 'error');
            return;
        }

        if (!document.fullscreenElement) {
            // Enter fullscreen
            if (container.requestFullscreen) {
                container.requestFullscreen();
            } else if (container.webkitRequestFullscreen) { // Safari
                container.webkitRequestFullscreen();
            } else if (container.msRequestFullscreen) { // IE11
                container.msRequestFullscreen();
            }
            container.classList.add('is-fullscreen');
        } else {
            // Exit fullscreen
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.webkitExitFullscreen) {
                document.webkitExitFullscreen();
            } else if (document.msExitFullscreen) {
                document.msExitFullscreen();
            }
            container.classList.remove('is-fullscreen');
        }
    }

    // Handle fullscreen change event to update icon
    document.addEventListener('fullscreenchange', function () {
        var container = document.getElementById('scatter-chart-container');
        var btn = container ? container.querySelector('.btn-icon .material-symbols-outlined') : null;
        if (document.fullscreenElement) {
            if (btn) btn.textContent = 'fullscreen_exit';
            if (container) container.classList.add('is-fullscreen');
        } else {
            if (btn) btn.textContent = 'fullscreen';
            if (container) container.classList.remove('is-fullscreen');
        }
    });

    /**
     * Filter scatter chart by activity type
     * @param {string} type - 'all', 'inspection', 'stationary', 'onboarding'
     */
    function filterScatterType(type) {
        scatterTypeFilter = type;

        // Update filter pills UI
        var pills = document.querySelectorAll('#scatter-type-pills .perf-pill');
        pills.forEach(function (pill) {
            pill.classList.toggle('active', pill.dataset.value === type);
        });

        // Re-render with all filters preserved
        refreshScatterChart();
    }

    // ===========================================
    // HELPERS
    // ===========================================
    function updateFilterPills(containerId, active) {
        const container = document.getElementById(containerId);
        if (!container) return;
        container.querySelectorAll('.perf-pill').forEach(pill => {
            pill.classList.toggle('active', pill.dataset.value === active);
        });
    }

    function padZero(n) {
        return String(n).padStart(2, '0');
    }

    function formatTimeAgo(dateStr) {
        if (!dateStr) return '';
        const date = new Date(dateStr);
        const now = new Date();
        const diff = Math.floor((now - date) / 1000);

        if (diff < 60) return 'Just now';
        if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
        if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
        return Math.floor(diff / 86400) + 'd ago';
    }

    function escapeHtml(str) {
        if (!str) return '';
        return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    // ===========================================
    // BULK EXPORT LOGIC (CSV Implementation)
    // ===========================================
    var exportLocations = []; // Available sites
    var selectedExportLocations = []; // Selected for export
    var currentExportPageIndex = 0;

    function openExportModal() {
        const modal = document.getElementById('export-modal');
        if (!modal) return;
        modal.classList.add('active');

        // Populate Sites
        // We use 'perfData.sites.list' if available, or extract from scatterData
        const sitesSet = {};
        if (perfData && perfData.sites && perfData.sites.list) {
            perfData.sites.list.forEach(s => sitesSet[s.nameEN] = true);
        } else if (perfData && perfData.inspections && perfData.inspections.scatterData) {
            perfData.inspections.scatterData.forEach(d => { if (d.siteName) sitesSet[d.siteName] = true; });
        }

        exportLocations = Object.keys(sitesSet).sort();
        selectedExportLocations = [...exportLocations]; // Default all
        currentExportPageIndex = 0;

        // Initialize Export Date Range Picker (V2.1 Feature)
        initExportDatePicker();

        renderExportBundleList();
        updateExportBundleDisplay();
        updateExportPreview();
    }

    // Export Date Range Picker Instance
    let exportDatePicker = null;
    let exportDateRange = { start: null, end: null };

    function initExportDatePicker() {
        const input = document.getElementById('exportDateRange');
        if (!input) return;

        // Destroy existing instance if any
        if (exportDatePicker) {
            exportDatePicker.destroy();
        }

        // Sync with main performance date range
        const mainStart = perfDateRange.start ? new Date(perfDateRange.start) : new Date();
        const mainEnd = perfDateRange.end ? new Date(perfDateRange.end) : new Date();

        exportDateRange = { start: perfDateRange.start, end: perfDateRange.end };

        // Initialize Flatpickr
        exportDatePicker = flatpickr(input, {
            mode: 'range',
            dateFormat: 'Y-m-d',
            defaultDate: [mainStart, mainEnd],
            maxDate: 'today',
            onChange: function (selectedDates) {
                if (selectedDates.length === 2) {
                    exportDateRange.start = selectedDates[0].toISOString().split('T')[0];
                    exportDateRange.end = selectedDates[1].toISOString().split('T')[0];
                    updateExportPreview();
                }
            }
        });
    }

    function getExportDateRange() {
        // Return export-specific date range if set, otherwise fall back to main
        if (exportDateRange.start && exportDateRange.end) {
            return exportDateRange;
        }
        return perfDateRange;
    }

    function closeExportModal() {
        const modal = document.getElementById('export-modal');
        if (modal) modal.classList.remove('active');
    }

    function renderExportBundleList() {
        const container = document.getElementById('exportBundleList');
        if (!container) return;
        container.innerHTML = '';

        exportLocations.forEach((loc) => {
            const isSelected = selectedExportLocations.includes(loc);
            const isActive = selectedExportLocations[currentExportPageIndex] === loc;

            const item = document.createElement('div');
            item.className = `export-bundle-item ${isActive ? 'active' : ''}`;
            item.onclick = function () {
                toggleExportLocation(loc, !isSelected);
            };

            item.innerHTML = `
                <input type="checkbox" class="report-loc-checkbox" ${isSelected ? 'checked' : ''} style="pointer-events: none;">
                <span class="text-xs font-medium truncate flex-1 ${isSelected ? 'text-primary' : ''}">${loc}</span>
             `;
            container.appendChild(item);
        });
    }

    function toggleExportLocation(loc, isChecked) {
        if (isChecked) {
            if (!selectedExportLocations.includes(loc)) {
                selectedExportLocations.push(loc);
                selectedExportLocations.sort();
            }
        } else {
            selectedExportLocations = selectedExportLocations.filter(l => l !== loc);
        }

        // Adjust index
        if (currentExportPageIndex >= selectedExportLocations.length) {
            currentExportPageIndex = Math.max(0, selectedExportLocations.length - 1);
        }

        updateExportBundleDisplay();
        updateExportPreview();
        renderExportBundleList();
    }

    function selectAllExport() {
        selectedExportLocations = [...exportLocations];
        currentExportPageIndex = 0;
        updateExportBundleDisplay();
        updateExportPreview();
        renderExportBundleList();
    }

    function clearAllExport() {
        selectedExportLocations = [];
        currentExportPageIndex = 0;
        updateExportBundleDisplay();
        updateExportPreview();
        renderExportBundleList();
    }

    function updateExportBundleDisplay() {
        const count = selectedExportLocations.length;
        document.getElementById('exportBundleCount').textContent = `${count} Sites`;

        // Realistic PDF size: ~0.85MB per report (V2.1 formula)
        const sizeMB = (count * 0.85).toFixed(1);
        document.getElementById('estimatedBundleSize').textContent = `~${sizeMB} MB`;
        // Progress bar simulation (up to 50MB capacity)
        const progress = Math.min(100, (parseFloat(sizeMB) / 50) * 100);
        document.getElementById('exportSizeBar').style.width = progress + '%';

        const pageInfo = document.getElementById('exportPageInfo');
        if (count === 0) pageInfo.textContent = '0 / 0';
        else pageInfo.textContent = `Page ${currentExportPageIndex + 1} of ${count}`;

        document.getElementById('prevPageBtn').disabled = count <= 1 || currentExportPageIndex === 0;
        document.getElementById('nextPageBtn').disabled = count <= 1 || currentExportPageIndex === count - 1;
        document.getElementById('btnDownloadBundle').disabled = count === 0;
    }

    function prevExportPage() {
        if (currentExportPageIndex > 0) {
            currentExportPageIndex--;
            updateExportPreview();
            renderExportBundleList();
            updateExportBundleDisplay();
        }
    }

    function nextExportPage() {
        if (currentExportPageIndex < selectedExportLocations.length - 1) {
            currentExportPageIndex++;
            updateExportPreview();
            renderExportBundleList();
            updateExportBundleDisplay();
        }
    }

    /**
     * Renders a single location report into a specifically provided container element.
     * Decoupled from global IDs to support off-screen rendering.
     */
    /**
     * Renders a single location report into a specifically provided container element.
     * Decoupled from global IDs to support off-screen rendering.
     */
    function renderLocationReport(container, locName) {
        if (!container || !locName) return;

        const nameEl = container.querySelector('.export-pdf-title');
        const yAxisEl = container.querySelector('.export-y-axis');
        const xAxisEl = container.querySelector('.export-x-axis');
        const dotsContainer = container.querySelector('.export-scatter-dots');

        if (nameEl) nameEl.textContent = locName;

        // Populate footer generation date
        const genDateEl = container.querySelector('#exportGenDate') || container.querySelector('.export-pdf-gen-date span');
        if (genDateEl) {
            const now = new Date();
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            genDateEl.textContent = months[now.getMonth()] + ' ' + String(now.getDate()).padStart(2, '0') + ', ' + now.getFullYear();
        }

        if (!perfData || !perfData.inspections || !perfData.inspections.scatterData) {
            if (dotsContainer) dotsContainer.innerHTML = '';
            return;
        }

        const locData = perfData.inspections.scatterData.filter(d => d.siteName === locName);

        // Use export-specific date range (V2.1 Feature)
        const dateRange = getExportDateRange();

        // Date Range Scaling
        const start = new Date(dateRange.start);
        start.setHours(0, 0, 0, 0);
        const end = new Date(dateRange.end);
        end.setHours(23, 59, 59, 999);

        // Calculate number of days
        const oneDay = 1000 * 60 * 60 * 24;
        const numDays = Math.floor((end.getTime() - start.getTime() + 1000) / oneDay);
        // +1000ms to handle slight rounding/boundary issues, effectively ceil of duration in days if full days.
        // Actually simpler:
        const diffTime = Math.abs(end - start);
        const totalDays = Math.ceil(diffTime / oneDay);
        // Jan 1 00:00 to Jan 1 23:59 is 0.99 days -> 1 day.

        // Render Y-Axis Labels (Time) - Vertical Axis
        if (yAxisEl) {
            // Standard 2-hour intervals starting at 06:00
            // V2.1 Standard: 25 hourly labels from 06:00 to 06:00
            const hours = [6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 0, 1, 2, 3, 4, 5, 6];
            let labels = '';
            hours.forEach(h => {
                labels += `<span>${String(h).padStart(2, '0')}:00</span>`;
            });
            yAxisEl.innerHTML = labels;
        }

        // Render X-Axis Labels (Dates) - Horizontal Axis
        if (xAxisEl) {
            let labels = '';
            const curr = new Date(start);
            // Limit labels if too many
            const showEvery = totalDays > 31 ? 2 : 1;

            for (let i = 0; i < totalDays; i++) {
                if (i % showEvery === 0) {
                    const dayNum = String(curr.getDate()).padStart(2, '0');
                    labels += `<span>${dayNum}</span>`;
                }
                curr.setDate(curr.getDate() + 1);
            }
            xAxisEl.innerHTML = labels;
        }

        // Render Points
        if (dotsContainer) {
            dotsContainer.innerHTML = '';

            locData.forEach(d => {
                if (!d.date) return;

                const pointDate = new Date(d.date);
                pointDate.setHours(0, 0, 0, 0);

                // X-Position = Date Index (Left to Right)
                const dayIndex = Math.floor((pointDate - start) / oneDay);
                let xPercent = 0;
                if (totalDays > 1) {
                    xPercent = (dayIndex / (totalDays - 1)) * 100;
                } else {
                    xPercent = 50; // Center if single day
                }
                xPercent = Math.max(0, Math.min(100, xPercent));

                // Y-Position = Time (Top to Bottom)
                let h = d.hour || 0;
                let m = d.minute || 0;
                let minutesFromStart = 0;

                // Shift starts at 06:00
                if (h >= 6) {
                    minutesFromStart = (h - 6) * 60 + m;
                } else {
                    // Times before 06:00 (e.g. 02:00) 
                    // should be at the end of the timeline
                    minutesFromStart = (h + 18) * 60 + m;
                }

                const totalMinutesInDay = 24 * 60;
                const yPercent = (minutesFromStart / totalMinutesInDay) * 100;

                let color = '#3b82f6';

                // Color based on Time (Vertical Shift Regions)
                if (yPercent >= 33.33 && yPercent < 66.66) color = '#f59e0b';
                else if (yPercent >= 66.66) color = '#a855f7';

                if (d.type === 'stationary') color = '#ef4444';
                else if (d.type === 'onboarding') color = '#10b981';

                const dot = document.createElement('div');
                dot.className = 'scatter-dot';
                dot.style.left = `${xPercent}%`;
                dot.style.top = `${yPercent}%`;
                dot.style.background = color;
                dot.title = `${d.date} ${padZero(h)}:${padZero(m)}`;

                dotsContainer.appendChild(dot);
            });
        }
    }

    // UI Updater Wrapper
    function updateExportPreview() {
        var container = document.getElementById('pdfPreviewContent');
        var pane = document.querySelector('.export-preview-pane');
        if (!container || !pane) return;

        // V2.1 Logic: CSS handles scaling via transform: scale(0.7)
        // No manual JS scaling needed here. The preview container uses standard flow.

        if (selectedExportLocations.length === 0) {
            var nameEl = container.querySelector('.export-pdf-title');
            if (nameEl) nameEl.textContent = 'No Selection';
            return;
        }

        renderLocationReport(container, selectedExportLocations[currentExportPageIndex]);

        // Update page number in footer
        var pageNumEl = container.querySelector('.export-pdf-page-num');
        if (pageNumEl) {
            pageNumEl.textContent = 'Page ' + (currentExportPageIndex + 1) + ' of ' + selectedExportLocations.length;
        }
    }

    // === PDF & ZIP Export Implementation (V2.1 Pattern - Direct Capture) ===
    async function generateAndDownloadZIP(event) {
        if (selectedExportLocations.length === 0) {
            if (typeof Toast !== 'undefined' && Toast.show) {
                Toast.show('Please select at least one location to export', 'warning');
            } else {
                alert('Please select at least one location to export');
            }
            return;
        }

        const btn = document.getElementById('btnDownloadBundle');
        const originalContent = btn.innerHTML;

        // V2.1 Pattern: Capture the preview element logic
        const elementToCapture = document.getElementById('pdfPreviewContent');
        if (!elementToCapture) {
            alert('Error: Preview element not found');
            return;
        }

        try {
            // Show progress toast (V2.1 UX pattern)
            if (typeof Toast !== 'undefined' && Toast.show) {
                Toast.show(`Generating ${selectedExportLocations.length} high-quality PDF reports...`, 'info');
            }
            btn.disabled = true;
            btn.innerHTML = `<span class="material-symbols-outlined animate-spin text-[18px]">progress_activity</span> Generating... <span id="zipProgress">0/${selectedExportLocations.length}</span>`;

            const zip = new JSZip();
            const folder = zip.folder("VKS_Patrol_Reports");
            const { jsPDF } = window.jspdf;

            for (let i = 0; i < selectedExportLocations.length; i++) {
                const progressEl = document.getElementById('zipProgress');
                if (progressEl) progressEl.textContent = `${i + 1}/${selectedExportLocations.length}`;

                const locName = selectedExportLocations[i];

                // Switch to this location (updates the visible preview)
                currentExportPageIndex = i;
                updateExportPreview();
                renderExportBundleList();

                // Wait for render (fonts, layout, images)
                await new Promise(resolve => setTimeout(resolve, 800));

                // Update page number per location
                var pageNumEl = elementToCapture.querySelector('.export-pdf-page-num');
                if (pageNumEl) {
                    pageNumEl.textContent = 'Page ' + (i + 1) + ' of ' + selectedExportLocations.length;
                }

                // V2.1 Export Pattern: Capture preview element directly
                const canvas = await html2canvas(elementToCapture, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff'
                });

                // Create PDF (A4 Landscape)
                const pdf = new jsPDF('l', 'mm', 'a4');
                const imgData = canvas.toDataURL('image/jpeg', 0.95);

                const pdfWidth = 297;
                const pdfHeight = 210;
                const margin = 10;

                const imgProps = pdf.getImageProperties(imgData);
                const imgWidth = pdfWidth - (margin * 2);
                const imgHeight = (imgProps.height * imgWidth) / imgProps.width;
                const y = (pdfHeight - imgHeight) / 2;

                pdf.addImage(imgData, 'JPEG', margin, y, imgWidth, imgHeight);

                const cleanName = locName.replace(/[^a-z0-9]/gi, '_');
                folder.file(`${cleanName}_Report.pdf`, pdf.output('blob'));
            }

            const content = await zip.generateAsync({ type: "blob" });
            saveAs(content, `VKS_Patrol_Reports_${new Date().toISOString().split('T')[0]}.zip`);

        } catch (err) {
            console.error(err);
            if (typeof Toast !== 'undefined' && Toast.show) {
                Toast.show('Error generating ZIP: ' + err.message, 'error');
            } else {
                alert('Error generating ZIP: ' + err.message);
            }
        } finally {
            // Restore original state (reset to first page)
            currentExportPageIndex = 0;
            updateExportPreview();
            renderExportBundleList();
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = originalContent;
            }
        }
    }

    function exportPerformanceReport() {
        openExportModal();
    }

    // Auto-init navigation hook (Layer 2: memory cache guard)
    function init_performance() {
        // If we already have data AND flatpickr is initialized, skip re-init
        // This makes revisiting the page instant instead of re-fetching
        if (perfData && flatpickrPerf) {
            console.log('[Performance] Memory cache hit ‚Äî instant render');
            renderAllSections();
            return;
        }
        if (typeof initPerformancePage === 'function') {
            initPerformancePage();
        }
    }

    // ===========================================
    // AI ANALYSIS TAB ‚Äî Insight Cards + References
    // ===========================================

    var aiTabInitialized = false;
    var aiReferences = {}; // Shared reference store

    // --- Init on first tab switch ---
    function initAITab() {
        if (aiTabInitialized) return;
        aiTabInitialized = true;
        loadBriefingSection();
        loadPatternsSection();
    }

    // --- SECTION 1: Briefing ---
    function loadBriefingSection() {
        var container = document.getElementById('ai-briefing-cards');
        if (!container) return;
        container.innerHTML = buildLoadingHTML();

        google.script.run
            .withSuccessHandler(function (data) {
                if (data && data.success && data.insights) {
                    Object.assign(aiReferences, data.references || {});
                    renderInsightCards('ai-briefing-cards', data.insights);
                    var meta = document.getElementById('ai-briefing-meta');
                    if (meta) meta.textContent = (data.date || '') + (data.generatedAt ? ' ‚Ä¢ Generated ' + data.generatedAt : '');
                } else {
                    container.innerHTML = buildEmptyHTML('No briefing available yet. Click Regenerate to create one.');
                }
            })
            .withFailureHandler(function (err) {
                container.innerHTML = buildErrorHTML(err.message || 'Connection error');
            })
            .getAIBriefing();
    }

    function regenerateBriefing() {
        var btn = document.getElementById('ai-briefing-regen-btn');
        var container = document.getElementById('ai-briefing-cards');
        if (btn) btn.disabled = true;
        if (container) container.innerHTML = buildLoadingHTML('Generating briefing...');

        google.script.run
            .withSuccessHandler(function (result) {
                if (btn) btn.disabled = false;
                if (result && result.success && result.insights) {
                    Object.assign(aiReferences, result.references || {});
                    renderInsightCards('ai-briefing-cards', result.insights);
                    var meta = document.getElementById('ai-briefing-meta');
                    if (meta) meta.textContent = (result.date || 'Today') + ' ‚Ä¢ Generated just now';
                    showToast('Briefing regenerated', 'success');
                } else {
                    container.innerHTML = buildErrorHTML((result && result.error) || 'Generation failed');
                    showToast('Briefing generation failed', 'error');
                }
            })
            .withFailureHandler(function (err) {
                if (btn) btn.disabled = false;
                container.innerHTML = buildErrorHTML(err.message || 'Connection error');
                showToast('Connection failed', 'error');
            })
            .regenerateDailyBriefing();
    }

    // --- SECTION 2: Deep Analysis ---
    function runDeepAnalysis() {
        var topic = document.getElementById('ai-topic-select').value;
        var btn = document.getElementById('ai-analyze-btn');
        var container = document.getElementById('ai-deep-cards');
        if (!topic || !container) return;

        if (btn) btn.disabled = true;
        container.innerHTML = buildLoadingHTML('Analyzing ' + topic + '...');

        google.script.run
            .withSuccessHandler(function (result) {
                if (btn) btn.disabled = false;
                if (result && result.success && result.insights) {
                    Object.assign(aiReferences, result.references || {});
                    renderInsightCards('ai-deep-cards', result.insights);
                    showToast('Analysis complete', 'success');
                } else {
                    container.innerHTML = buildErrorHTML((result && result.error) || 'Analysis failed');
                }
            })
            .withFailureHandler(function (err) {
                if (btn) btn.disabled = false;
                container.innerHTML = buildErrorHTML(err.message || 'Connection error');
            })
            .analyzePerformanceTopic(topic);
    }

    // --- SECTION 3: Risk Patterns ---
    function loadPatternsSection() {
        var container = document.getElementById('ai-patterns-cards');
        if (!container) return;
        container.innerHTML = buildLoadingHTML();

        google.script.run
            .withSuccessHandler(function (data) {
                if (data && data.success && data.insights) {
                    Object.assign(aiReferences, data.references || {});
                    renderInsightCards('ai-patterns-cards', data.insights);
                    var meta = document.getElementById('ai-patterns-meta');
                    if (meta) meta.textContent = data.generatedAt ? 'Last analyzed: ' + data.generatedAt : '';
                } else {
                    container.innerHTML = buildEmptyHTML('No risk patterns available. Click Regenerate to analyze.');
                }
            })
            .withFailureHandler(function (err) {
                container.innerHTML = buildErrorHTML(err.message || 'Connection error');
            })
            .getAIPatternAnalysis();
    }

    function regeneratePatterns() {
        var btn = document.getElementById('ai-patterns-regen-btn');
        var container = document.getElementById('ai-patterns-cards');
        if (btn) btn.disabled = true;
        if (container) container.innerHTML = buildLoadingHTML('Analyzing patterns...');

        google.script.run
            .withSuccessHandler(function (result) {
                if (btn) btn.disabled = false;
                if (result && result.success && result.insights) {
                    Object.assign(aiReferences, result.references || {});
                    renderInsightCards('ai-patterns-cards', result.insights);
                    var meta = document.getElementById('ai-patterns-meta');
                    if (meta) meta.textContent = 'Last analyzed: just now';
                    showToast('Pattern analysis regenerated', 'success');
                } else {
                    container.innerHTML = buildErrorHTML((result && result.error) || 'Analysis failed');
                }
            })
            .withFailureHandler(function (err) {
                if (btn) btn.disabled = false;
                container.innerHTML = buildErrorHTML(err.message || 'Connection error');
            })
            .regenerateWeeklyPatterns();
    }

    // ===========================================
    // INSIGHT CARD RENDERER
    // ===========================================

    function renderInsightCards(containerId, insights) {
        var container = document.getElementById(containerId);
        if (!container || !insights) return;

        var lang = (typeof TranslationManager !== 'undefined') ? TranslationManager.currentLang : 'en';
        var isLao = (lang === 'lo');

        var html = '<div class="ai-insight-grid">';
        insights.forEach(function (card, idx) {
            var sevClass = 'ai-sev-' + (card.severity || 'good');
            var trendIcon = card.trend === 'improving' ? 'üìà' : (card.trend === 'declining' ? 'üìâ' : '‚û°Ô∏è');
            var trendClass = 'ai-trend-' + (card.trend || 'stable');

            var title = isLao && card.titleLo ? card.titleLo : (card.title || '');
            var detail = isLao && card.detailLo ? card.detailLo : (card.detail || '');

            html += '<div class="ai-insight-card ' + sevClass + '">';

            // Header row: icon + title + trend
            html += '<div class="ai-card-header">';
            html += '<span class="ai-card-icon">' + (card.icon || 'üí°') + '</span>';
            html += '<span class="ai-card-title">' + escapeHtml(title) + '</span>';
            html += '<span class="ai-card-trend ' + trendClass + '">' + trendIcon + '</span>';
            html += '</div>';

            // Detail text
            html += '<p class="ai-card-detail">' + escapeHtml(detail) + '</p>';

            // Metric chips
            if (card.metrics && card.metrics.length > 0) {
                html += '<div class="ai-metrics-row">';
                card.metrics.forEach(function (m) {
                    var deltaHtml = m.delta ? '<span class="ai-chip-delta ' + (m.delta.startsWith('+') ? 'delta-up' : 'delta-down') + '">' + escapeHtml(m.delta) + '</span>' : '';
                    html += '<span class="ai-metric-chip">';
                    html += '<span class="ai-chip-value">' + escapeHtml(m.value || '') + '</span>';
                    html += deltaHtml;
                    html += '<span class="ai-chip-label">' + escapeHtml(m.label || '') + '</span>';
                    html += '</span>';
                });
                html += '</div>';
            }

            // Reference tags
            if (card.refKeys && card.refKeys.length > 0) {
                html += '<div class="ai-ref-tags">';
                card.refKeys.forEach(function (rk) {
                    var ref = aiReferences[rk];
                    if (!ref) return;
                    var refIcon = ref.type === 'table' ? 'üìã' : (ref.type === 'site' ? 'üè¢' : (ref.type === 'guard' ? 'üë§' : 'üè∑Ô∏è'));
                    html += '<button class="ai-ref-tag" onclick="toggleReference(\'' + rk + '\', this)">';
                    html += refIcon + ' ' + escapeHtml(ref.label || rk);
                    html += '<span class="material-symbols-outlined ai-ref-chevron">expand_more</span>';
                    html += '</button>';
                });
                html += '</div>';

                // Expandable reference panels (hidden by default)
                card.refKeys.forEach(function (rk) {
                    var ref = aiReferences[rk];
                    if (!ref) return;
                    html += '<div class="ai-ref-expanded" id="ref-' + rk.replace(/[^a-zA-Z0-9]/g, '_') + '" style="display:none;">';
                    html += renderReferenceContent(rk, ref);
                    html += '</div>';
                });
            }

            html += '</div>'; // close card
        });
        html += '</div>';

        container.innerHTML = html;
    }

    // ===========================================
    // REFERENCE EXPANSION SYSTEM
    // ===========================================

    function toggleReference(refKey, btn) {
        var panelId = 'ref-' + refKey.replace(/[^a-zA-Z0-9]/g, '_');
        var panel = document.getElementById(panelId);
        if (!panel) return;

        var isOpen = panel.style.display !== 'none';
        panel.style.display = isOpen ? 'none' : 'block';

        // Toggle chevron
        var chevron = btn.querySelector('.ai-ref-chevron');
        if (chevron) chevron.textContent = isOpen ? 'expand_more' : 'expand_less';

        // Toggle active state on tag
        btn.classList.toggle('active', !isOpen);
    }

    function renderReferenceContent(refKey, ref) {
        if (!ref) return '';

        switch (ref.type) {
            case 'table':
                return renderRefTable(ref);
            case 'site':
                return renderRefSite(ref);
            case 'guard':
                return renderRefGuard(ref);
            default:
                return '<p class="text-muted">' + escapeHtml(ref.label || refKey) + '</p>';
        }
    }

    function renderRefTable(ref) {
        var html = '<div class="ai-ref-table-wrapper">';
        html += '<table class="ai-ref-table">';
        html += '<thead><tr>';
        (ref.columns || []).forEach(function (col) {
            html += '<th>' + escapeHtml(col) + '</th>';
        });
        html += '</tr></thead><tbody>';
        (ref.rows || []).forEach(function (row) {
            html += '<tr>';
            row.forEach(function (cell) {
                var cellStr = (cell === null || cell === undefined) ? '' : cell.toString();
                // Highlight severity/status cells
                var cls = '';
                var lower = cellStr.toLowerCase();
                if (lower === 'critical' || lower === 'high') cls = 'ai-cell-critical';
                else if (lower === 'medium' || lower === 'warning') cls = 'ai-cell-warning';
                else if (lower === 'resolved' || lower === 'completed') cls = 'ai-cell-good';
                html += '<td class="' + cls + '">' + escapeHtml(cellStr) + '</td>';
            });
            html += '</tr>';
        });
        html += '</tbody></table>';

        if (ref.nav) {
            html += '<div class="ai-ref-nav">';
            html += '<a class="ai-drilldown" onclick="navigateTo(\'' + ref.nav.page + '\')">';
            html += 'View all in ' + escapeHtml(ref.nav.page.replace(/-/g, ' ')) + ' ‚Üí';
            html += '</a></div>';
        }
        html += '</div>';
        return html;
    }

    function renderRefSite(ref) {
        var d = ref.data || {};
        var html = '<div class="ai-ref-site-card">';
        html += '<div class="ai-ref-site-name">' + escapeHtml(d.name || ref.label) + '</div>';
        html += '<div class="ai-ref-site-details">';
        if (d.guards) html += '<span>üë§ ' + d.guards + ' guards</span>';
        if (d.status) html += '<span>‚óè ' + escapeHtml(d.status) + '</span>';
        if (d.contract) html += '<span>üìÑ ' + escapeHtml(d.contract) + '</span>';
        html += '</div>';
        if (ref.nav) {
            html += '<a class="ai-drilldown" onclick="navigateTo(\'' + ref.nav.page + '\')">View in ' + escapeHtml(ref.nav.page.replace(/-/g, ' ')) + ' ‚Üí</a>';
        }
        html += '</div>';
        return html;
    }

    function renderRefGuard(ref) {
        var d = ref.data || {};
        var html = '<div class="ai-ref-guard-card">';
        html += '<div class="ai-ref-guard-name">' + escapeHtml(d.name || ref.label) + '</div>';
        if (d.site) html += '<span class="text-muted">Site: ' + escapeHtml(d.site) + '</span>';
        if (ref.nav) {
            html += '<a class="ai-drilldown" onclick="navigateTo(\'' + ref.nav.page + '\')">View Activity ‚Üí</a>';
        }
        html += '</div>';
        return html;
    }

    // ===========================================
    // UI HELPERS
    // ===========================================

    function buildLoadingHTML(msg) {
        return '<div class="ai-loading-state"><span class="material-symbols-outlined spin">progress_activity</span><span>' + (msg || 'Loading insights...') + '</span></div>';
    }

    function buildEmptyHTML(msg) {
        return '<div class="ai-empty-state"><span class="material-symbols-outlined" style="font-size:48px;color:var(--text-muted);">lightbulb</span><p class="text-muted">' + (msg || 'No data available') + '</p></div>';
    }

    function buildErrorHTML(msg) {
        return '<div class="ai-empty-state"><span class="material-symbols-outlined" style="font-size:48px;color:var(--danger);">error</span><p class="text-muted">' + escapeHtml(msg || 'An error occurred') + '</p></div>';
    }

    // Hook: auto-init when AI tab is shown
    var _origSwitchTab = typeof switchPerfTab === 'function' ? switchPerfTab : null;
    // We patch in the tab switch listener below
</script>
<script>
    // Patch switchPerfTab to init AI tab on first visit
    (function () {
        var origRenderTabData = (typeof renderTabData === 'function') ? renderTabData : function () { };
        window._origRenderTabData = origRenderTabData;
        window.renderTabData = function (tabId) {
            if (tabId === 'ai') {
                initAITab();
            } else {
                origRenderTabData(tabId);
            }
        };
    })();
</script>

<!-- BULK EXPORT MODAL -->
<div id="export-modal" class="dialog-overlay">
    <div class="dialog export-dialog">
        <!-- Header -->
        <div class="dialog-header">
            <div class="flex items-center gap-4">
                <div class="stat-icon-destructive">
                    <span class="material-symbols-outlined">table_chart</span>
                </div>
                <div>
                    <h3 class="text-xl font-bold" data-i18n="perf.export_title">Bulk Export Preview</h3>
                    <p class="text-sm text-muted" data-i18n="perf.export_sub">Review and download site performance
                        reports</p>
                </div>
            </div>
            <button onclick="closeExportModal()" class="btn-icon">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>

        <!-- Content: Two-Pane Layout -->
        <div class="export-layout">
            <!-- Preview Pane (Left) -->
            <div class="export-preview-pane">
                <!-- Toolbar / Pagination -->
                <div class="export-toolbar">
                    <div class="export-pagination">
                        <button onclick="prevExportPage()" id="prevPageBtn" class="btn-icon-sm">
                            <span class="material-symbols-outlined">chevron_left</span>
                        </button>
                        <span id="exportPageInfo" class="text-sm font-medium tabular-nums">Page 1 of 1</span>
                        <button onclick="nextExportPage()" id="nextPageBtn" class="btn-icon-sm">
                            <span class="material-symbols-outlined">chevron_right</span>
                        </button>
                    </div>
                </div>

                <!-- PDF Page Simulation (V2.1 Exact) -->
                <div class="export-pdf-page" id="pdfPreviewContent">
                    <!-- PDF Header -->
                    <div class="export-pdf-header">
                        <div class="badge badge-secondary mb-2" style="background: #f1f5f9; color: #64748b;">
                            <span class="material-symbols-outlined text-[10px] mr-1">domain</span>
                            <span data-i18n="perf.location_report">LOCATION REPORT</span>
                        </div>
                        <h1 id="previewLocationName" class="export-pdf-title">Location Name</h1>
                    </div>

                    <!-- PDF Subtitle -->
                    <div class="export-pdf-subtitle">
                        <div>
                            <h2 data-i18n="perf.shift_analysis">SHIFT DISTRIBUTION ANALYSIS</h2>
                            <p class="text-xs text-muted mt-1 normal-case" style="color: #64748b;">Daily patrol
                                activities timeline (Month View)</p>
                        </div>
                        <div class="text-right">
                            <div class="font-bold">VKS QC DASHBOARD</div>
                            <div class="text-xs text-muted" style="color: #64748b;">Performance Analytics</div>
                        </div>
                    </div>

                    <!-- Shift Legend -->
                    <div class="shift-legend mb-4">
                        <div class="shift-legend-item">
                            <span class="shift-legend-dot shift-1-dot"></span> SHIFT 1 (06-14)
                        </div>
                        <div class="shift-legend-item">
                            <span class="shift-legend-dot shift-2-dot"></span> SHIFT 2 (14-22)
                        </div>
                        <div class="shift-legend-item">
                            <span class="shift-legend-dot shift-3-dot"></span> SHIFT 3 (22-06)
                        </div>
                    </div>

                    <!-- Chart Container -->
                    <div class="export-pdf-chart-container">
                        <div class="flex flex-1 relative" style="display: flex; flex: 1; position: relative;">
                            <!-- Y-Axis (Dates) - Placeholder, filled by JS -->
                            <div class="export-y-axis">
                                <!-- Populated by JS -->
                            </div>
                            <!-- Chart Area -->
                            <div class="export-chart-area" id="previewCanvas">
                                <div class="export-shift-regions">
                                    <div class="shift-1-region"></div>
                                    <div class="shift-2-region"></div>
                                    <div class="shift-3-region"></div>
                                </div>
                                <div class="export-scatter-grid"></div>
                                <div id="pdfScatterDots" class="export-scatter-dots"></div>
                            </div>
                        </div>
                        <!-- X-Axis -->
                        <div id="pdfXAxis" class="export-x-axis"></div>
                    </div>

                    <!-- PDF Page Footer -->
                    <div
                        style="display: flex; justify-content: space-between; margin-top: auto; padding-top: 12px; font-size: 11px; color: #94a3b8;">
                        <span class="export-pdf-gen-date">Generated on <span id="exportGenDate"></span></span>
                        <span class="export-pdf-page-num">Page 1 of 1</span>
                    </div>
                </div>
            </div>


            <!-- Sidebar (Right) -->
            <div class="export-sidebar">
                <div class="export-sidebar-content custom-scrollbar">
                    <!-- Date Range Section (V2.1 Feature) -->
                    <div class="space-y-4 mb-4 pb-4" style="border-bottom: 1px solid var(--border);">
                        <div class="flex items-center justify-between">
                            <h4 class="text-xs font-bold text-muted uppercase tracking-wider"
                                data-i18n="perf.date_range">
                                Date Range</h4>
                        </div>
                        <div class="input-icon-wrapper">
                            <span class="material-symbols-outlined input-icon"
                                style="font-size: 16px;">calendar_month</span>
                            <input type="text" id="exportDateRange" class="input w-full" placeholder="Select date range"
                                readonly style="padding-left: 36px; font-size: 13px;">
                        </div>
                        <p class="text-xs text-muted" data-i18n="perf.date_range_hint">
                            Adjust the date range for exported reports
                        </p>
                    </div>

                    <!-- Bundle Section -->
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <h4 class="text-xs font-bold text-muted uppercase tracking-wider"
                                data-i18n="perf.selection">
                                Selection</h4>
                            <span id="exportBundleCount" class="badge badge-primary">0 Sites</span>
                        </div>

                        <!-- Quick Actions -->
                        <div class="flex gap-2">
                            <button onclick="selectAllExport()" class="btn btn-outline btn-sm flex-1">
                                <span data-i18n="common.select_all">Select All</span>
                            </button>
                            <button onclick="clearAllExport()" class="btn btn-ghost btn-sm flex-1">
                                <span data-i18n="common.clear">Clear</span>
                            </button>
                        </div>

                        <!-- List -->
                        <div class="export-bundle-list" id="exportBundleList">
                            <!-- Populated by JS -->
                        </div>

                        <!-- Info Alert -->
                        <div class="p-3 bg-blue-50 text-blue-700 rounded-md text-xs flex gap-2">
                            <span class="material-symbols-outlined text-sm">info</span>
                            <p data-i18n="perf.pdf_note">Each selected site will be exported as an individual PDF file
                                within a ZIP archive.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div class="export-sidebar-footer">
                    <div class="mb-3">
                        <div class="flex justify-between text-xs mb-1">
                            <span class="text-muted" data-i18n="perf.est_size">Est. Size</span>
                            <span id="estimatedBundleSize" class="font-medium">0 KB</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-1.5">
                            <div id="exportSizeBar" class="bg-primary h-1.5 rounded-full transition-all"
                                style="width: 0%">
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-primary w-full" id="btnDownloadBundle"
                        onclick="generateAndDownloadZIP(event)">
                        <span class="material-symbols-outlined">download</span>
                        <span data-i18n="perf.download_pdf">Download PDF Reports</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>