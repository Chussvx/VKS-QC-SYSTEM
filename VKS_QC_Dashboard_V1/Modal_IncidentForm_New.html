<!-- 
    Modal_IncidentForm_New.html
    Stitch-generated comprehensive incident form, converted to GAS template format
    Version: v160
-->

<!-- Incident Form Modal Template (Comprehensive with ALL Fields) -->
<template id="modal-incident-form-new">
    <div class="flex flex-col w-full bg-white rounded-xl shadow-2xl overflow-hidden relative"
        style="max-height: 90vh; width: 100%; max-width: 700px;">

        <!-- Header -->
        <div class="flex items-center justify-between px-6 py-5 border-b border-gray-100 bg-white">
            <div class="flex items-center gap-3">
                <div class="h-10 w-10 rounded-full bg-green-50 flex items-center justify-center text-green-600">
                    <span class="material-symbols-outlined">security</span>
                </div>
                <div>
                    <h2 class="text-xl font-bold text-gray-900 modal-title leading-tight"
                        data-i18n="incident.form.title">New Incident Report</h2>
                    <p class="text-xs text-gray-500"><span data-i18n="table.id">ID</span>: <span
                            id="incident-display-id" data-i18n="incident.form.auto_id">Auto-generated</span></p>
                </div>
            </div>
            <button class="text-gray-400 hover:text-gray-600 transition-colors p-2 rounded-full hover:bg-gray-100"
                onclick="closeModal()">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>

        <!-- Tabs -->
        <div class="px-6 border-b border-gray-100 bg-gray-50/50">
            <div class="flex space-x-8">
                <button type="button"
                    class="incident-tab relative py-4 px-1 text-sm font-bold text-green-600 border-b-2 border-green-600"
                    data-tab="basic" data-i18n="incident.form.tab.basic">
                    Basic Info
                </button>
                <button type="button"
                    class="incident-tab relative py-4 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 border-b-2 border-transparent hover:border-gray-300"
                    data-tab="details" data-i18n="incident.form.tab.details">
                    Details
                </button>
                <button type="button"
                    class="incident-tab relative py-4 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 border-b-2 border-transparent hover:border-gray-300"
                    data-tab="impact" data-i18n="incident.form.tab.impact">
                    Impact & Response
                </button>
            </div>
        </div>

        <!-- Scrollable Content -->
        <div class="p-6 overflow-y-auto bg-white flex-grow" style="max-height: 50vh;">
            <form id="form-incident-new" data-incident-id="">

                <!-- TAB 1: BASIC INFO -->
                <div id="incident-tab-basic" class="incident-tab-content">
                    <!-- Title -->
                    <div class="mb-4">
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 required"
                            data-i18n="incident.form.incident_title">
                            Incident Title
                        </label>
                        <input type="text" id="incident-title-new"
                            class="w-full h-12 px-4 rounded-lg border border-gray-200 bg-gray-50 text-gray-900 placeholder-gray-400 focus:border-green-500 focus:ring-green-500 focus:ring-1 text-sm"
                            placeholder="e.g., Unauthorized Access at Main Gate"
                            data-i18n-placeholder="incident.form.incident_title" required>
                    </div>

                    <!-- Site & Category Row -->
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 required"
                                data-i18n="incident.form.site_location">
                                Site Location
                            </label>
                            <input type="hidden" id="incident-site-new" required>
                            <div class="custom-select" id="incident-site-dropdown" style="width: 100%;">
                                <!-- Populated by initIncidentFormControls() -->
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 required"
                                data-i18n="incident.form.category">
                                Category
                            </label>
                            <input type="hidden" id="incident-category-new" required>
                            <div class="custom-select" id="incident-category-dropdown" style="width: 100%;">
                                <!-- Populated by initIncidentFormControls() -->
                            </div>
                        </div>
                    </div>

                    <!-- Priority Selector -->
                    <div class="mb-4">
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-3 required"
                            data-i18n="incident.form.priority_level">
                            Priority Level
                        </label>
                        <div class="grid grid-cols-4 gap-3">
                            <label class="cursor-pointer">
                                <input type="radio" name="incident-priority-new" value="p1" class="peer sr-only"
                                    required>
                                <div
                                    class="h-full flex flex-col items-center justify-center p-3 rounded-lg border border-gray-200 bg-white hover:bg-red-50 peer-checked:border-red-500 peer-checked:bg-red-50 peer-checked:ring-1 peer-checked:ring-red-500 transition-all">
                                    <div class="h-2 w-2 rounded-full bg-red-500 mb-2"></div>
                                    <span class="text-sm font-bold text-gray-700 peer-checked:text-red-700">P1</span>
                                    <span class="text-[10px] uppercase font-bold text-gray-400 mt-1"
                                        data-i18n="incident.form.critical">Critical</span>
                                </div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="radio" name="incident-priority-new" value="p2" class="peer sr-only">
                                <div
                                    class="h-full flex flex-col items-center justify-center p-3 rounded-lg border border-gray-200 bg-white hover:bg-orange-50 peer-checked:border-orange-500 peer-checked:bg-orange-50 peer-checked:ring-1 peer-checked:ring-orange-500 transition-all">
                                    <div class="h-2 w-2 rounded-full bg-orange-500 mb-2"></div>
                                    <span class="text-sm font-bold text-gray-700 peer-checked:text-orange-700">P2</span>
                                    <span class="text-[10px] uppercase font-bold text-gray-400 mt-1"
                                        data-i18n="incident.form.high">High</span>
                                </div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="radio" name="incident-priority-new" value="p3" class="peer sr-only">
                                <div
                                    class="h-full flex flex-col items-center justify-center p-3 rounded-lg border border-gray-200 bg-white hover:bg-yellow-50 peer-checked:border-yellow-500 peer-checked:bg-yellow-50 peer-checked:ring-1 peer-checked:ring-yellow-500 transition-all">
                                    <div class="h-2 w-2 rounded-full bg-yellow-500 mb-2"></div>
                                    <span class="text-sm font-bold text-gray-700 peer-checked:text-yellow-700">P3</span>
                                    <span class="text-[10px] uppercase font-bold text-gray-400 mt-1"
                                        data-i18n="incident.form.medium">Medium</span>
                                </div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="radio" name="incident-priority-new" value="p4" class="peer sr-only">
                                <div
                                    class="h-full flex flex-col items-center justify-center p-3 rounded-lg border border-gray-200 bg-white hover:bg-blue-50 peer-checked:border-blue-500 peer-checked:bg-blue-50 peer-checked:ring-1 peer-checked:ring-blue-500 transition-all">
                                    <div class="h-2 w-2 rounded-full bg-blue-500 mb-2"></div>
                                    <span class="text-sm font-bold text-gray-700 peer-checked:text-blue-700">P4</span>
                                    <span class="text-[10px] uppercase font-bold text-gray-400 mt-1"
                                        data-i18n="incident.form.low">Low</span>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Incident Date/Time -->
                    <div class="mb-4">
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 required"
                            data-i18n="incident.form.incident_datetime">
                            Incident Date & Time
                        </label>
                        <div style="position: relative;">
                            <input type="text" id="incident-datetime-new" readonly
                                class="form-input w-full cursor-pointer" style="height: 3rem; padding-right: 2.5rem;"
                                placeholder="Select date & time..." required>
                            <span class="material-symbols-outlined"
                                style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #9ca3af; pointer-events: none; font-size: 20px;">calendar_today</span>
                        </div>
                        <p class="text-xs text-gray-400 mt-1 flex items-center gap-1">
                            <span class="material-symbols-outlined text-[14px]">info</span>
                            <span data-i18n="incident.form.datetime_hint">When did the incident occur?</span>
                        </p>
                    </div>
                </div>

                <!-- TAB 2: DETAILS -->
                <div id="incident-tab-details" class="incident-tab-content hidden">
                    <!-- Exact Location -->
                    <div class="mb-4">
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 required"
                            data-i18n="incident.form.exact_location">
                            Exact Location
                        </label>
                        <input type="text" id="incident-location-new"
                            class="w-full h-12 px-4 rounded-lg border border-gray-200 bg-gray-50 text-gray-900 placeholder-gray-400 focus:border-green-500 focus:ring-green-500 focus:ring-1 text-sm"
                            placeholder="e.g., Building A, Floor 2, Near Emergency Exit"
                            data-i18n-placeholder="incident.form.exact_location" required>
                    </div>

                    <!-- Description -->
                    <div class="mb-4">
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 required"
                            data-i18n="incident.form.description">
                            Detailed Description
                        </label>
                        <textarea id="incident-description-new" rows="4"
                            class="w-full px-4 py-3 rounded-lg border border-gray-200 bg-gray-50 text-gray-900 placeholder-gray-400 focus:border-green-500 focus:ring-green-500 focus:ring-1 text-sm resize-y"
                            placeholder="Describe what happened in detail..."
                            data-i18n-placeholder="incident.form.description" required></textarea>
                    </div>

                    <!-- Reporter Info -->
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 required"
                                data-i18n="incident.form.reported_by">
                                Reported By
                            </label>
                            <input type="text" id="incident-reported-by-new"
                                class="w-full h-12 px-4 rounded-lg border border-gray-200 bg-gray-50 text-gray-900 placeholder-gray-400 focus:border-green-500 focus:ring-green-500 focus:ring-1 text-sm"
                                placeholder="Name of person reporting" data-i18n-placeholder="incident.form.reported_by"
                                required>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2"
                                data-i18n="incident.form.reported_to">
                                Reported To
                            </label>
                            <input type="text" id="incident-reported-to-new"
                                class="w-full h-12 px-4 rounded-lg border border-gray-200 bg-gray-50 text-gray-900 placeholder-gray-400 focus:border-green-500 focus:ring-green-500 focus:ring-1 text-sm"
                                placeholder="Who was notified" data-i18n-placeholder="incident.form.reported_to">
                        </div>
                    </div>

                    <!-- Witnesses -->
                    <div class="mb-4">
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2"
                            data-i18n="incident.form.witnesses">
                            Witnesses
                        </label>
                        <textarea id="incident-witnesses-new" rows="2"
                            class="w-full px-4 py-3 rounded-lg border border-gray-200 bg-gray-50 text-gray-900 placeholder-gray-400 focus:border-green-500 focus:ring-green-500 focus:ring-1 text-sm resize-y"
                            placeholder="Names and contact info of any witnesses..."
                            data-i18n-placeholder="incident.form.witnesses"></textarea>
                    </div>
                </div>

                <!-- TAB 3: IMPACT & RESPONSE -->
                <div id="incident-tab-impact" class="incident-tab-content hidden">
                    <!-- Response Info -->
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2"
                                data-i18n="incident.form.response_time">
                                Response Time
                            </label>
                            <div style="position: relative;">
                                <input type="text" id="incident-response-time-new" readonly
                                    class="form-input w-full cursor-pointer"
                                    style="height: 3rem; padding-right: 2.5rem;" placeholder="Select response time...">
                                <span class="material-symbols-outlined"
                                    style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #9ca3af; pointer-events: none; font-size: 20px;">schedule</span>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2"
                                data-i18n="incident.form.responded_by">
                                Responded By
                            </label>
                            <input type="text" id="incident-responded-by-new"
                                class="w-full h-12 px-4 rounded-lg border border-gray-200 bg-gray-50 text-gray-900 placeholder-gray-400 focus:border-green-500 focus:ring-green-500 focus:ring-1 text-sm"
                                placeholder="Name of responder" data-i18n-placeholder="incident.form.responded_by">
                        </div>
                    </div>

                    <!-- Impact Checkboxes -->
                    <div class="mb-4">
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-3"
                            data-i18n="incident.form.impact_assessment">
                            Impact Assessment
                        </label>
                        <div class="grid grid-cols-2 gap-3">
                            <label
                                class="flex items-center gap-3 p-3 rounded-lg border border-gray-200 bg-white hover:bg-gray-50 cursor-pointer">
                                <input type="checkbox" id="incident-injuries-new"
                                    class="w-4 h-4 rounded border-gray-300 text-green-600 focus:ring-green-500">
                                <span class="text-sm text-gray-700" data-i18n="incident.form.injuries">Injuries
                                    Reported</span>
                            </label>
                            <label
                                class="flex items-center gap-3 p-3 rounded-lg border border-gray-200 bg-white hover:bg-gray-50 cursor-pointer">
                                <input type="checkbox" id="incident-property-damage-new"
                                    class="w-4 h-4 rounded border-gray-300 text-green-600 focus:ring-green-500">
                                <span class="text-sm text-gray-700" data-i18n="incident.form.property_damage">Property
                                    Damage</span>
                            </label>
                            <label
                                class="flex items-center gap-3 p-3 rounded-lg border border-gray-200 bg-white hover:bg-gray-50 cursor-pointer">
                                <input type="checkbox" id="incident-authorities-new"
                                    class="w-4 h-4 rounded border-gray-300 text-green-600 focus:ring-green-500">
                                <span class="text-sm text-gray-700" data-i18n="incident.form.authorities">Authorities
                                    Notified</span>
                            </label>
                            <label
                                class="flex items-center gap-3 p-3 rounded-lg border border-gray-200 bg-white hover:bg-gray-50 cursor-pointer">
                                <input type="checkbox" id="incident-cctv-new"
                                    class="w-4 h-4 rounded border-gray-300 text-green-600 focus:ring-green-500">
                                <span class="text-sm text-gray-700" data-i18n="incident.form.cctv">CCTV Available</span>
                            </label>
                        </div>
                    </div>

                    <!-- Financial & Legal -->
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2"
                                data-i18n="incident.form.estimated_loss">
                                Estimated Loss ($)
                            </label>
                            <div class="relative">
                                <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400">$</span>
                                <input type="number" id="incident-loss-new" min="0" step="0.01"
                                    class="w-full h-12 pl-8 pr-4 rounded-lg border border-gray-200 bg-gray-50 text-gray-900 placeholder-gray-400 focus:border-green-500 focus:ring-green-500 focus:ring-1 text-sm"
                                    placeholder="0.00">
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2"
                                data-i18n="incident.form.police_report">
                                Police Report #
                            </label>
                            <input type="text" id="incident-police-report-new"
                                class="w-full h-12 px-4 rounded-lg border border-gray-200 bg-gray-50 text-gray-900 placeholder-gray-400 focus:border-green-500 focus:ring-green-500 focus:ring-1 text-sm"
                                placeholder="If applicable" data-i18n-placeholder="incident.form.police_report">
                        </div>
                    </div>

                    <!-- Immediate Actions -->
                    <div class="mb-4">
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2"
                            data-i18n="incident.form.immediate_actions">
                            Immediate Actions Taken
                        </label>
                        <textarea id="incident-actions-new" rows="3"
                            class="w-full px-4 py-3 rounded-lg border border-gray-200 bg-gray-50 text-gray-900 placeholder-gray-400 focus:border-green-500 focus:ring-green-500 focus:ring-1 text-sm resize-y"
                            placeholder="What immediate actions were taken..."
                            data-i18n-placeholder="incident.form.immediate_actions"></textarea>
                    </div>

                    <!-- Photo Evidence -->
                    <div class="mb-4">
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2"
                            data-i18n="incident.form.photo_evidence">
                            Photo Evidence (Optional)
                        </label>
                        <div id="incident-upload-zone" class="upload-drop-zone"
                            onclick="document.getElementById('incident-photo-input').click()">
                            <span class="material-symbols-outlined"
                                style="font-size: 2rem; color: #9ca3af;">cloud_upload</span>
                            <p class="text-sm text-gray-500 mt-1">Click or drag photos here</p>
                            <p class="text-xs text-gray-400">Max 3 photos, 5MB each (JPG, PNG)</p>
                            <input type="file" id="incident-photo-input" multiple accept="image/*" style="display:none"
                                onchange="handlePhotoSelect(event, 'incident')">
                        </div>
                        <div id="incident-photo-preview" class="photo-preview-grid"></div>
                    </div>

                    <!-- Notes -->
                    <div class="mb-4">
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2"
                            data-i18n="incident.form.additional_notes">
                            Additional Notes
                        </label>
                        <textarea id="incident-notes-new" rows="2"
                            class="w-full px-4 py-3 rounded-lg border border-gray-200 bg-gray-50 text-gray-900 placeholder-gray-400 focus:border-green-500 focus:ring-green-500 focus:ring-1 text-sm resize-y"
                            placeholder="Any additional notes..."
                            data-i18n-placeholder="incident.form.additional_notes"></textarea>
                    </div>
                </div>

            </form>
        </div>

        <!-- Footer -->
        <div class="px-6 py-4 bg-gray-50 border-t border-gray-100 flex items-center justify-between shrink-0">
            <div class="flex gap-2">
                <button type="button" id="incident-prev-btn"
                    class="hidden px-4 py-2.5 rounded-lg border border-gray-300 text-sm font-semibold text-gray-700 hover:bg-gray-100 transition-colors"
                    onclick="incidentFormPrevTab()">
                    <span class="material-symbols-outlined text-[18px] align-middle">chevron_left</span>
                    <span data-i18n="incident.form.btn.previous">Previous</span>
                </button>
            </div>
            <div class="flex gap-3">
                <button type="button"
                    class="px-5 py-2.5 rounded-lg border border-gray-300 text-sm font-semibold text-gray-700 hover:bg-gray-100 transition-colors"
                    onclick="closeModal()" data-i18n="incident.form.btn.cancel">
                    Cancel
                </button>
                <button type="button" id="incident-next-btn"
                    class="px-5 py-2.5 rounded-lg bg-gray-600 hover:bg-gray-700 text-white text-sm font-bold transition-all flex items-center gap-2"
                    onclick="incidentFormNextTab()">
                    <span data-i18n="incident.form.btn.next">Next</span>
                    <span class="material-symbols-outlined text-[18px]">chevron_right</span>
                </button>
                <button type="button" id="incident-save-btn"
                    class="hidden px-5 py-2.5 rounded-lg bg-green-600 hover:bg-green-700 text-white text-sm font-bold shadow-lg shadow-green-600/30 transition-all flex items-center gap-2"
                    onclick="submitIncidentFormNew()">
                    <span class="material-symbols-outlined text-[18px]" id="btn-incident-icon">save</span>
                    <span data-i18n="incident.form.btn.save" id="btn-incident-text">Save Incident</span>
                </button>
            </div>
        </div>
    </div>
</template>

<script>
    // Tab state
    var incidentFormCurrentTab = 'basic';
    var incidentFormTabs = ['basic', 'details', 'impact'];

    // Tab switching
    function switchIncidentTab(tabName) {
        incidentFormCurrentTab = tabName;

        // Update tab buttons
        document.querySelectorAll('.incident-tab').forEach(function (btn) {
            if (btn.dataset.tab === tabName) {
                btn.classList.add('text-green-600', 'border-green-600', 'font-bold');
                btn.classList.remove('text-gray-500', 'border-transparent');
            } else {
                btn.classList.remove('text-green-600', 'border-green-600', 'font-bold');
                btn.classList.add('text-gray-500', 'border-transparent');
            }
        });

        // Show/hide tab content
        document.querySelectorAll('.incident-tab-content').forEach(function (content) {
            content.classList.add('hidden');
        });
        document.getElementById('incident-tab-' + tabName).classList.remove('hidden');

        // Update navigation buttons
        var tabIndex = incidentFormTabs.indexOf(tabName);
        document.getElementById('incident-prev-btn').classList.toggle('hidden', tabIndex === 0);
        document.getElementById('incident-next-btn').classList.toggle('hidden', tabIndex === incidentFormTabs.length - 1);
        document.getElementById('incident-save-btn').classList.toggle('hidden', tabIndex !== incidentFormTabs.length - 1);
    }

    function incidentFormNextTab() {
        var currentIndex = incidentFormTabs.indexOf(incidentFormCurrentTab);
        if (currentIndex < incidentFormTabs.length - 1) {
            switchIncidentTab(incidentFormTabs[currentIndex + 1]);
        }
    }

    function incidentFormPrevTab() {
        var currentIndex = incidentFormTabs.indexOf(incidentFormCurrentTab);
        if (currentIndex > 0) {
            switchIncidentTab(incidentFormTabs[currentIndex - 1]);
        }
    }

    // Initialize tab click handlers
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.incident-tab').forEach(function (btn) {
            btn.addEventListener('click', function () {
                switchIncidentTab(this.dataset.tab);
            });
        });
    });

    /** Initialize all premium form controls for Incident modal */
    function initIncidentFormControls() {
        // Category dropdown (static items)
        initVKSDropdown({
            containerId: 'incident-category-dropdown',
            hiddenInputId: 'incident-category-new',
            placeholder: (typeof t === 'function' && t('incident.form.select_category')) || 'Select category...',
            searchable: false,
            items: [
                { value: 'theft', label: 'Theft / Loss', icon: 'üîí' },
                { value: 'fire', label: 'Fire', icon: 'üî•' },
                { value: 'medical', label: 'Medical Emergency', icon: 'üè•' },
                { value: 'vandalism', label: 'Vandalism', icon: 'üíî' },
                { value: 'access', label: 'Access Violation', icon: 'üö™' },
                { value: 'suspicious', label: 'Suspicious Activity', icon: 'üëÅÔ∏è' },
                { value: 'safety', label: 'Safety Hazard', icon: '‚ö†Ô∏è' }
            ]
        });

        // Site dropdown (dynamic items ‚Äî loaded separately via loadSiteOptionsVKS)
        initVKSDropdown({
            containerId: 'incident-site-dropdown',
            hiddenInputId: 'incident-site-new',
            placeholder: (typeof t === 'function' && t('incident.form.select_site')) || 'Select site...',
            searchable: true,
            items: []
        });

        // Flatpickr: Incident Date & Time
        initVKSFlatpickr('incident-datetime-new', {
            enableTime: true,
            dateFormat: 'Y-m-dTH:i',
            time_24hr: true
        });

        // Flatpickr: Response Time
        initVKSFlatpickr('incident-response-time-new', {
            enableTime: true,
            dateFormat: 'Y-m-dTH:i',
            time_24hr: true
        });

        // Photo upload drag-and-drop
        initUploadDragDrop('incident-upload-zone', 'incident');
    }

    // Submit function with ALL fields
    function submitIncidentFormNew() {
        var form = document.getElementById('form-incident-new');
        var btn = document.getElementById('incident-save-btn');
        var icon = document.getElementById('btn-incident-icon');
        var text = document.getElementById('btn-incident-text');

        // Validate required fields
        var title = document.getElementById('incident-title-new').value.trim();
        var siteId = document.getElementById('incident-site-new').value;
        var category = document.getElementById('incident-category-new').value;
        var severityEl = document.querySelector('input[name="incident-priority-new"]:checked');
        var incidentTime = document.getElementById('incident-datetime-new').value;
        var location = document.getElementById('incident-location-new').value.trim();
        var description = document.getElementById('incident-description-new').value.trim();
        var reportedBy = document.getElementById('incident-reported-by-new').value.trim();

        if (!title || !siteId || !category || !severityEl || !incidentTime || !description || !reportedBy) {
            // Collect missing fields with IDs for inline highlighting
            var missingFields = [];
            var firstMissingTab = null;
            if (!title) { missingFields.push({ label: 'Incident Title', fieldId: 'incident-title-new', type: 'input' }); if (!firstMissingTab) firstMissingTab = 'basic'; }
            if (!siteId) { missingFields.push({ label: 'Site Location', fieldId: 'incident-site-dropdown', type: 'dropdown' }); if (!firstMissingTab) firstMissingTab = 'basic'; }
            if (!category) { missingFields.push({ label: 'Category', fieldId: 'incident-category-dropdown', type: 'dropdown' }); if (!firstMissingTab) firstMissingTab = 'basic'; }
            if (!severityEl) { missingFields.push({ label: 'Priority Level', fieldId: 'incident-priority-new', type: 'radio' }); if (!firstMissingTab) firstMissingTab = 'basic'; }
            if (!incidentTime) { missingFields.push({ label: 'Incident Date/Time', fieldId: 'incident-datetime-new', type: 'input' }); if (!firstMissingTab) firstMissingTab = 'basic'; }
            if (!description) { missingFields.push({ label: 'Description', fieldId: 'incident-description-new', type: 'input' }); if (!firstMissingTab) firstMissingTab = 'details'; }
            if (!reportedBy) { missingFields.push({ label: 'Reported By', fieldId: 'incident-reported-by-new', type: 'input' }); if (!firstMissingTab) firstMissingTab = 'details'; }

            // Auto-switch to tab with the first missing field
            if (firstMissingTab && typeof switchIncidentTab === 'function') {
                switchIncidentTab(firstMissingTab);
            }

            showValidationErrorModal(missingFields);
            return;
        }

        var data = {
            id: form.dataset.incidentId || null,
            title: title,
            siteId: siteId,
            category: category,
            severity: severityEl.value,
            incidentTime: new Date(incidentTime).toISOString(),
            location: location,
            description: description,
            reportedBy: reportedBy,
            reportedTo: document.getElementById('incident-reported-to-new').value.trim(),
            reportedTime: new Date().toISOString(),
            witnesses: document.getElementById('incident-witnesses-new').value.trim(),
            responseTime: document.getElementById('incident-response-time-new').value ? new Date(document.getElementById('incident-response-time-new').value).toISOString() : null,
            respondedBy: document.getElementById('incident-responded-by-new').value.trim(),
            injuries: document.getElementById('incident-injuries-new').checked,
            propertyDamage: document.getElementById('incident-property-damage-new').checked,
            authoritiesNotified: document.getElementById('incident-authorities-new').checked,
            cctvAvailable: document.getElementById('incident-cctv-new').checked,
            estimatedLoss: parseFloat(document.getElementById('incident-loss-new').value) || 0,
            policeReportNo: document.getElementById('incident-police-report-new').value.trim(),
            immediateActions: document.getElementById('incident-actions-new').value.trim(),
            notes: document.getElementById('incident-notes-new').value.trim(),
            photos: getPhotoData('incident')
        };

        // Button loading state
        if (btn) {
            btn.disabled = true;
            if (icon) { icon.textContent = 'progress_activity'; icon.classList.add('animate-spin'); }
            if (text) text.textContent = 'Saving...';
        }

        console.log('Submitting incident data:', data);

        google.script.run
            .withSuccessHandler(function (result) {
                // Reset button
                if (btn) {
                    btn.disabled = false;
                    if (icon) { icon.textContent = 'save'; icon.classList.remove('animate-spin'); }
                    if (text) text.textContent = 'Save Incident';
                }
                if (result && result.success) {
                    showToast('Incident saved successfully!', 'success');
                    clearPhotoUploads('incident');
                    closeModal();
                    if (typeof loadIncidents === 'function') loadIncidents();
                } else {
                    console.error('Save failed (business error):', result);
                    try {
                        if (typeof showSaveErrorModal === 'function') {
                            showSaveErrorModal(
                                'Incident Save Failed',
                                result ? result.error : 'Unknown error',
                                'The incident report could not be saved to the database'
                            );
                        } else {
                            throw new Error('showSaveErrorModal not defined');
                        }
                    } catch (e) {
                        console.error('Fallback: Save error modal failed:', e);
                        alert('Incident Save Failed: ' + (result ? result.error : 'Unknown error'));
                    }
                }
            })
            .withFailureHandler(function (error) {
                // Reset button on error
                if (btn) {
                    btn.disabled = false;
                    if (icon) { icon.textContent = 'save'; icon.classList.remove('animate-spin'); }
                    if (text) text.textContent = 'Save Incident';
                }
                console.error('Save failed (server error):', error);
                try {
                    if (typeof showSaveErrorModal === 'function') {
                        showSaveErrorModal(
                            'Incident Save Error',
                            error.message || 'Connection failed',
                            'A server error occurred while saving the incident report'
                        );
                    } else {
                        throw new Error('showSaveErrorModal not defined');
                    }
                } catch (e) {
                    console.error('Fallback: Save error modal failed:', e);
                    alert('Incident Save Error: ' + (error.message || 'Connection failed'));
                }
            })
            .saveIncident(data);
    }
</script>