<!-- Modal_ChangePassword.html - Change Password Dialog -->
<template id="modal-change-password">
    <div class="modal-card" style="max-width: 440px; width: 100%;">
        <!-- Header -->
        <div class="modal-header">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-blue-100 text-blue-600 rounded-lg">
                    <span class="material-symbols-outlined">lock_reset</span>
                </div>
                <div>
                    <h3 class="font-semibold text-lg" data-i18n="auth.change_password.title">Change Password</h3>
                    <p class="text-xs text-muted" data-i18n="auth.change_password.desc">Update your account password</p>
                </div>
            </div>
            <button class="modal-close-btn" onclick="closeModal()">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>

        <!-- Body -->
        <div class="modal-body p-6">
            <div id="pwd-change-error" class="mb-4" style="display: none;
                background: rgba(239,68,68,0.08); border: 1px solid rgba(239,68,68,0.2);
                color: var(--danger); border-radius: 10px; padding: 10px 14px; font-size: 13px;
                display: none; align-items: center; gap: 8px;">
                <span class="material-symbols-outlined" style="font-size: 16px;">error</span>
                <span id="pwd-change-error-text"></span>
            </div>

            <div class="form-group mb-4">
                <label class="form-label" data-i18n="auth.current_password">Current Password</label>
                <input type="password" id="pwd-current" class="form-input w-full" placeholder="Enter current password"
                    required>
            </div>
            <div class="form-group mb-4">
                <label class="form-label" data-i18n="auth.new_password">New Password</label>
                <input type="password" id="pwd-new" class="form-input w-full" placeholder="Enter new password" required>
            </div>
            <div class="form-group mb-4">
                <label class="form-label" data-i18n="auth.confirm_password">Confirm New Password</label>
                <input type="password" id="pwd-confirm" class="form-input w-full" placeholder="Confirm new password"
                    required>
            </div>
        </div>

        <!-- Footer -->
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()" data-i18n="common.cancel">Cancel</button>
            <button class="btn btn-primary" id="pwd-change-btn" onclick="submitPasswordChange()">
                <span class="material-symbols-outlined" style="font-size: 18px;">lock</span>
                <span data-i18n="auth.change_password.submit">Update Password</span>
            </button>
        </div>
    </div>
</template>

<script>
    function submitPasswordChange() {
        var currentPwd = document.getElementById('pwd-current').value;
        var newPwd = document.getElementById('pwd-new').value;
        var confirmPwd = document.getElementById('pwd-confirm').value;
        var errorDiv = document.getElementById('pwd-change-error');
        var errorText = document.getElementById('pwd-change-error-text');
        var btn = document.getElementById('pwd-change-btn');

        // Validation
        if (!currentPwd || !newPwd || !confirmPwd) {
            showPwdError('All fields are required.');
            return;
        }
        if (newPwd.length < 6) {
            showPwdError('New password must be at least 6 characters.');
            return;
        }
        if (newPwd !== confirmPwd) {
            showPwdError('New passwords do not match.');
            return;
        }

        btn.disabled = true;
        btn.innerHTML = '<span class="material-symbols-outlined animate-spin" style="font-size: 18px;">progress_activity</span> Updating...';

        // Hash both passwords client-side
        Promise.all([sha256(currentPwd), sha256(newPwd)]).then(function (hashes) {
            var userId = SessionManager.getUserId();
            google.script.run
                .withSuccessHandler(function (result) {
                    btn.disabled = false;
                    btn.innerHTML = '<span class="material-symbols-outlined" style="font-size: 18px;">lock</span> <span>Update Password</span>';

                    if (result && result.success) {
                        closeModal();
                        showToast('Password changed successfully!', 'success');
                    } else {
                        showPwdError(result ? result.message : 'Failed to change password.');
                    }
                })
                .withFailureHandler(function (error) {
                    btn.disabled = false;
                    btn.innerHTML = '<span class="material-symbols-outlined" style="font-size: 18px;">lock</span> <span>Update Password</span>';
                    showPwdError('Connection error. Please try again.');
                })
                .changeMyPassword(userId, hashes[0], hashes[1]);
        });
    }

    function showPwdError(msg) {
        var errorDiv = document.getElementById('pwd-change-error');
        var errorText = document.getElementById('pwd-change-error-text');
        if (errorDiv && errorText) {
            errorText.textContent = msg;
            errorDiv.style.display = 'flex';
        }
    }
</script>